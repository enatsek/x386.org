<!-- HTML Header Start -->
<!DOCTYPE html>
<html><head>
<title>x386.org: Debian and Ubuntu Documentation</title>
<meta charset="UTF-8">
 
 
 
 
 
 
<style>
/* base.css */
body {
  box-sizing: border-box;
  min-width: 200px;
  max-width: 980px;
  margin: 0 auto;
  padding: 40px;
  border: 1px solid transparent;
}

body blockquote {
  background-color: initial;
}

body code {
  color: inherit;
}

body code > div {
  background: none;
}

body.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

body p,
body blockquote,
body ul,
body ol,
body dl,
body table,
body pre {
  margin-top: 16px;
  margin-bottom: 16px;
}

/* github-markdown.css */
body {
  color-scheme: dark;
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  margin: 0;
  color: #c9d1d9;
  background-color: #0d1117;
  font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";
  font-size: 16px;
  line-height: 1.5;
  word-wrap: break-word
}
body .octicon {
  display: inline-block;
  fill: currentColor;
  vertical-align: text-bottom
}
body h1:hover .anchor .octicon-link:before,
body h2:hover .anchor .octicon-link:before,
body h3:hover .anchor .octicon-link:before,
body h4:hover .anchor .octicon-link:before,
body h5:hover .anchor .octicon-link:before,
body h6:hover .anchor .octicon-link:before {
  width: 16px;
  height: 16px;
  content: ' ';
  display: inline-block;
  background-color: currentColor;
  -webkit-mask-image: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' version='1.1' aria-hidden='true'><path fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z'></path></svg>");
  mask-image: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' version='1.1' aria-hidden='true'><path fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z'></path></svg>")
}
body details,
body figcaption,
body figure {
  display: block
}
body summary {
  display: list-item
}
body a {
  background-color: transparent;
  color: #58a6ff;
  text-decoration: none
}
body a:active,
body a:hover {
  outline-width: 0
}
body abbr[title] {
  border-bottom: none;
  -webkit-text-decoration: underline dotted;
  text-decoration: underline dotted
}
body b,
body strong {
  font-weight: 600
}
body dfn {
  font-style: italic
}
body h1 {
  margin: .67em 0;
  font-weight: 600;
  padding-bottom: .3em;
  font-size: 1.8em;
  border-bottom: 1px solid #21262d
}
body mark {
  background-color: #ff0;
  color: #c9d1d9
}
body small {
  font-size: 90%
}
body sub,
body sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline
}
body sub {
  bottom: -.25em
}
body sup {
  top: -.5em
}
body img {
  border-style: none;
  max-width: 100%;
  box-sizing: content-box;
  background-color: #0d1117
}
body code,
body kbd,
body pre,
body samp {
  font-family: monospace,monospace;
  font-size: 1em
}
body figure {
  margin: 1em 40px
}
body hr {
  box-sizing: content-box;
  overflow: hidden;
  background: 0 0;
  border-bottom: 1px solid #21262d;
  height: .25em;
  padding: 0;
  margin: 24px 0;
  background-color: #30363d;
  border: 0
}
body [type=reset],
body [type=submit],
body html [type=button] {
  -webkit-appearance: button
}
body [type=button]::-moz-focus-inner,
body [type=reset]::-moz-focus-inner,
body [type=submit]::-moz-focus-inner {
  border-style: none;
  padding: 0
}
body [type=button]:-moz-focusring,
body [type=reset]:-moz-focusring,
body [type=submit]:-moz-focusring {
  outline: 1px dotted ButtonText
}
body [type=checkbox],
body [type=radio] {
  box-sizing: border-box;
  padding: 0
}
body [type=number]::-webkit-inner-spin-button,
body [type=number]::-webkit-outer-spin-button {
  height: auto
}
body [type=search] {
  -webkit-appearance: textfield;
  outline-offset: -2px
}
body [type=search]::-webkit-search-cancel-button,
body [type=search]::-webkit-search-decoration {
  -webkit-appearance: none
}
body ::-webkit-input-placeholder {
  color: inherit;
  opacity: .54
}
body ::-webkit-file-upload-button {
  -webkit-appearance: button;
  font: inherit
}
body a:hover {
  text-decoration: underline
}
body hr::before {
  display: table;
  content: ""
}
body hr::after {
  display: table;
  clear: both;
  content: ""
}
body table {
  border-spacing: 0;
  border-collapse: collapse;
  display: block;
  width: max-content;
  max-width: 100%;
  overflow: auto
}
body td,
body th {
  padding: 0
}
body details summary {
  cursor: pointer
}
body details:not([open]) > :not(summary) {
  display: none!important
}
body kbd {
  display: inline-block;
  padding: 3px 5px;
  font: 11px ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace;
  line-height: 10px;
  color: #c9d1d9;
  vertical-align: middle;
  background-color: #161b22;
  border: solid 1px rgba(110,118,129,.4);
  border-bottom-color: rgba(110,118,129,.4);
  border-radius: 6px;
  box-shadow: inset 0 -1px 0 rgba(110,118,129,.4)
}

details > summary {
  font-weight: 600;
  font-size: 1.4em;
  padding-top: .1em;
}


body h1,
body h2,
body h3,
body h4,
body h5,
body h6 {
  margin-top: 24px;
  margin-bottom: 16px;
  font-weight: 600;
  line-height: 1.25
}
body h2 {
  font-weight: 600;
  font-size: 1.6em;
  border-top: 1px solid #21262d;
  padding-top: .2em;
}
body h3 {
  font-weight: 600;
  font-size: 1.4em;
  border-top: 1px solid #21262d;
  padding-top: .2em;
}
body h4 {
  font-weight: 600;
  font-size: 1.2em;
  border-top: 1px solid #21262d;
  padding-top: .2em;
}
body h5 {
  font-weight: 600;
  font-size: 1.0em;
  border-top: 1px solid #21262d;
  padding-top: .2em;
}
body h6 {
  font-weight: 600;
  font-size: 1em;
  color: #8b949e
}
body p {
  margin-top: 0;
  margin-bottom: 10px
}
body blockquote {
  margin: 0;
  padding: 0 1em;
  color: #8b949e;
  border-left: .25em solid #30363d
}
body ol,
body ul {
  margin-top: 0;
  margin-bottom: 0;
  padding-left: 2em
}
body ol ol,
body ul ol {
  list-style-type: lower-roman
}
body ol ol ol,
body ol ul ol,
body ul ol ol,
body ul ul ol {
  list-style-type: lower-alpha
}
body dd {
  margin-left: 0
}
body code,
body tt {
  font-family: ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace;
  font-size: 12px
}
body pre {
  margin-top: 0;
  margin-bottom: 0;
  font-family: ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace;
  font-size: 12px;
  word-wrap: normal
}
body :-ms-input-placeholder {
  color: #484f58;
  opacity: 1
}
body ::-ms-input-placeholder {
  color: #484f58;
  opacity: 1
}
body ::placeholder {
  color: #484f58;
  opacity: 1
}
body .pl-c {
  color: #8b949e
}
body .pl-c1,
body .pl-s .pl-v {
  color: #79c0ff
}
body .pl-e,
body .pl-en {
  color: #d2a8ff
}
body .pl-s .pl-s1,
body .pl-smi {
  color: #c9d1d9
}
body .pl-ent {
  color: #7ee787
}
body .pl-k {
  color: #ff7b72
}
body .pl-pds,
body .pl-s,
body .pl-s .pl-pse .pl-s1,
body .pl-sr,
body .pl-sr .pl-cce,
body .pl-sr .pl-sra,
body .pl-sr .pl-sre {
  color: #a5d6ff
}
body .pl-smw,
body .pl-v {
  color: #ffa657
}
body .pl-bu {
  color: #f85149
}
body .pl-ii {
  color: #f0f6fc;
  background-color: #8e1519
}
body .pl-c2 {
  color: #f0f6fc;
  background-color: #b62324
}
body .pl-sr .pl-cce {
  font-weight: 700;
  color: #7ee787
}
body .pl-ml {
  color: #f2cc60
}
body .pl-mh,
body .pl-mh .pl-en,
body .pl-ms {
  font-weight: 700;
  color: #1f6feb
}
body .pl-mi {
  font-style: italic;
  color: #c9d1d9
}
body .pl-mb {
  font-weight: 700;
  color: #c9d1d9
}
body .pl-md {
  color: #ffdcd7;
  background-color: #67060c
}
body .pl-mi1 {
  color: #aff5b4;
  background-color: #033a16
}
body .pl-mc {
  color: #ffdfb6;
  background-color: #5a1e02
}
body .pl-mi2 {
  color: #c9d1d9;
  background-color: #1158c7
}
body .pl-mdr {
  font-weight: 700;
  color: #d2a8ff
}
body .pl-ba {
  color: #8b949e
}
body .pl-sg {
  color: #484f58
}
body .pl-corl {
  text-decoration: underline;
  color: #a5d6ff
}
body [data-catalyst] {
  display: block
}
body g-emoji {
  font-family: "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
  font-size: 1em;
  font-style: normal!important;
  font-weight: 400;
  line-height: 1;
  vertical-align: -.075em
}
body g-emoji img {
  width: 1em;
  height: 1em
}
body::before {
  display: table;
  content: ""
}
body::after {
  display: table;
  clear: both;
  content: ""
}
body > :first-child {
  margin-top: 0!important
}
body > :last-child {
  margin-bottom: 0!important
}
body a:not([href]) {
  color: inherit;
  text-decoration: none
}
body .absent {
  color: #f85149
}
body .anchor {
  float: left;
  padding-right: 4px;
  margin-left: -20px;
  line-height: 1
}
body .anchor:focus {
  outline: 0
}
body blockquote,
body details,
body dl,
body ol,
body p,
body pre,
body table,
body ul {
  margin-top: 0;
  margin-bottom: 16px
}
body blockquote > :first-child {
  margin-top: 0
}
body blockquote > :last-child {
  margin-bottom: 0
}
body sup > a::before {
  content: "["
}
body sup > a::after {
  content: "]"
}
body h1 .octicon-link,
body h2 .octicon-link,
body h3 .octicon-link,
body h4 .octicon-link,
body h5 .octicon-link,
body h6 .octicon-link {
  color: #c9d1d9;
  vertical-align: middle;
  visibility: hidden
}
body h1:hover .anchor,
body h2:hover .anchor,
body h3:hover .anchor,
body h4:hover .anchor,
body h5:hover .anchor,
body h6:hover .anchor {
  text-decoration: none
}
body h1:hover .anchor .octicon-link,
body h2:hover .anchor .octicon-link,
body h3:hover .anchor .octicon-link,
body h4:hover .anchor .octicon-link,
body h5:hover .anchor .octicon-link,
body h6:hover .anchor .octicon-link {
  visibility: visible
}
body h1 code,
body h1 tt,
body h2 code,
body h2 tt,
body h3 code,
body h3 tt,
body h4 code,
body h4 tt,
body h5 code,
body h5 tt,
body h6 code,
body h6 tt {
  padding: 0 .2em;
  font-size: inherit
}
body ol.no-list,
body ul.no-list {
  padding: 0;
  list-style-type: none
}
body ol[type="1"] {
  list-style-type: decimal
}
body ol[type=a] {
  list-style-type: lower-alpha
}
body ol[type=i] {
  list-style-type: lower-roman
}
body div > ol:not([type]) {
  list-style-type: decimal
}
body ol ol,
body ol ul,
body ul ol,
body ul ul {
  margin-top: 0;
  margin-bottom: 0
}
body li > p {
  margin-top: 16px
}
body li + li {
  margin-top: .25em
}
body dl {
  padding: 0
}
body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: 600
}
body dl dd {
  padding: 0 16px;
  margin-bottom: 16px
}
body table th {
  font-weight: 600
}
body table td,
body table th {
  padding: 6px 13px;
  border: 1px solid #30363d
}
body table tr {
  background-color: #0d1117;
  border-top: 1px solid #21262d
}
body table tr:nth-child(2n) {
  background-color: #161b22
}
body table img {
  background-color: transparent
}
body img[align=right] {
  padding-left: 20px
}
body img[align=left] {
  padding-right: 20px
}
body .emoji {
  max-width: none;
  vertical-align: text-top;
  background-color: transparent
}
body span.frame {
  display: block;
  overflow: hidden
}
body span.frame > span {
  display: block;
  float: left;
  width: auto;
  padding: 7px;
  margin: 13px 0 0;
  overflow: hidden;
  border: 1px solid #30363d
}
body span.frame span img {
  display: block;
  float: left
}
body span.frame span span {
  display: block;
  padding: 5px 0 0;
  clear: both;
  color: #c9d1d9
}
body span.align-center {
  display: block;
  overflow: hidden;
  clear: both
}
body span.align-center > span {
  display: block;
  margin: 13px auto 0;
  overflow: hidden;
  text-align: center
}
body span.align-center span img {
  margin: 0 auto;
  text-align: center
}
body span.align-right {
  display: block;
  overflow: hidden;
  clear: both
}
body span.align-right > span {
  display: block;
  margin: 13px 0 0;
  overflow: hidden;
  text-align: right
}
body span.align-right span img {
  margin: 0;
  text-align: right
}
body span.float-left {
  display: block;
  float: left;
  margin-right: 13px;
  overflow: hidden
}
body span.float-left span {
  margin: 13px 0 0
}
body span.float-right {
  display: block;
  float: right;
  margin-left: 13px;
  overflow: hidden
}
body span.float-right > span {
  display: block;
  margin: 13px auto 0;
  overflow: hidden;
  text-align: right
}
body code,
body tt {
  padding: .2em .4em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(110,118,129,.4);
  border-radius: 6px
}
body code br,
body tt br {
  display: none
}
body del code {
  text-decoration: inherit
}
body pre code {
  font-size: 100%
}
body pre > code {
  padding: 0;
  margin: 0;
  word-break: normal;
  white-space: pre;
  background: 0 0;
  border: 0
}
body .highlight {
  margin-bottom: 16px
}
body .highlight pre {
  margin-bottom: 0;
  word-break: normal
}
body .highlight pre,
body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #161b22;
  border-radius: 6px
}
body pre code,
body pre tt {
  display: inline;
  max-width: auto;
  padding: 0;
  margin: 0;
  overflow: visible;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0
}
body .csv-data td,
body .csv-data th {
  padding: 5px;
  overflow: hidden;
  font-size: 12px;
  line-height: 1;
  text-align: left;
  white-space: nowrap
}
body .csv-data .blob-num {
  padding: 10px 8px 9px;
  text-align: right;
  background: #0d1117;
  border: 0
}
body .csv-data tr {
  border-top: 0
}
body .csv-data th {
  font-weight: 600;
  background: #161b22;
  border-top: 0
}
body .footnotes {
  font-size: 12px;
  color: #8b949e;
  border-top: 1px solid #30363d
}
body .footnotes ol {
  padding-left: 16px
}
body .footnotes li {
  position: relative
}
body .footnotes li:target::before {
  position: absolute;
  top: -8px;
  right: -8px;
  bottom: -8px;
  left: -24px;
  pointer-events: none;
  content: "";
  border: 2px solid #1f6feb;
  border-radius: 6px
}
body .footnotes li:target {
  color: #c9d1d9
}
body .footnotes .data-footnote-backref g-emoji {
  font-family: monospace
}
body [hidden] {
  display: none!important
}
body ::-webkit-calendar-picker-indicator {
  filter: invert(50%)
}

/* node_modules/highlight.js/styles/github-dark.css */
pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}/*!
  Theme: GitHub Dark
  Description: Dark theme as seen on github.com
  Author: github.com
  Maintainer: @Hirse
  Updated: 2021-05-15

  Outdated base version: https://github.com/primer/github-syntax-dark
  Current colors taken from GitHub's CSS
*/.hljs{color:#c9d1d9;background:#0d1117}.hljs-doctag,.hljs-keyword,.hljs-meta .hljs-keyword,.hljs-template-tag,.hljs-template-variable,.hljs-type,.hljs-variable.language_{color:#ff7b72}.hljs-title,.hljs-title.class_,.hljs-title.class_.inherited__,.hljs-title.function_{color:#d2a8ff}.hljs-attr,.hljs-attribute,.hljs-literal,.hljs-meta,.hljs-number,.hljs-operator,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-variable{color:#79c0ff}.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#a5d6ff}.hljs-built_in,.hljs-symbol{color:#ffa657}.hljs-code,.hljs-comment,.hljs-formula{color:#8b949e}.hljs-name,.hljs-quote,.hljs-selector-pseudo,.hljs-selector-tag{color:#7ee787}.hljs-subst{color:#c9d1d9}.hljs-section{color:#1f6feb;font-weight:700}.hljs-bullet{color:#f2cc60}.hljs-emphasis{color:#c9d1d9;font-style:italic}.hljs-strong{color:#c9d1d9;font-weight:700}.hljs-addition{color:#aff5b4;background-color:#033a16}.hljs-deletion{color:#ffdcd7;background-color:#67060c}

</style>
</head>
<body>
<div class="document">
<div class="header"></div><div class="inner">
<!-- HTML Header End -->
<!-- Header Start -->

<h1>x386.org: Debian and Ubuntu Documentation</h1>
<h4>| &ensp;<a href="index.html">Home</a>&ensp; |&ensp; <a href="about.html">About</a> &ensp;| &ensp;<a href="contact.html">Contact</a>&ensp; | &ensp;<a href="license.html">License</a>&ensp; | &ensp;<a href="privacy_policy.html">Privacy Policy</a>&ensp; |</h4>
<!-- Copyright Start -->
<details>
<summary>Copyright (C) 2020 - 2025 Exforge exforge@x386.org</summary>
<hr />
<p>This document is free text: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or any later version.</p>
<p>This document is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.</p>
<p>You should have received a copy of the GNU General Public License along with this program.  If not, see: <a href="https://www.gnu.org/licenses/">www.gnu.org/licenses/</a>.</p>
<hr />
</details>
<!-- Copyright End -->

<!-- Header End -->
<p>0,1,2
3,4,5
6,7
8</p>
<h5>HAProxy</h5>
<h1>High Availability with HAProxy Load Balancer on Debian and Ubuntu</h1>
<details>
<summary>
0. Specs
</summary>
<hr />
<h3>0.1. The What</h3>
<p>HAProxy is a free, open-source software that acts as a high-availability load balancer and proxy for TCP and HTTP-based applications. It efficiently distributes requests across multiple servers and is widely used by high-traffic websites. HAProxy offers features like SSL termination, caching, and health checking.</p>
<p>This tutorial demonstrates how to set up High Availability Load Balancing with free Let's Encrypt certificates for HTTPS support.</p>
<h3>0.2. Environment</h3>
<ul>
<li>srv    : Load Balancer floating (virtual) IP --&gt; 192.168.1.200</li>
<li>srvlb1 : Load Balancer 1  --&gt; 192.168.1.201</li>
<li>srvlb2 : Load Balancer 2  --&gt; 192.168.1.202</li>
<li>srvaw1 : App/Web Server 1 --&gt; 192.168.1.203</li>
<li>srvaw2 : App/Web Server 2 --&gt; 192.168.1.204</li>
<li>srvaw3 : App/Web Server 3 --&gt; 192.168.1.205</li>
</ul>
<p>Tested on Debian 13/12 and Ubuntu 24.04/22.04 LTS Servers.</p>
<h3>0.3. Notes</h3>
<p>We will use a Keepalived cluster of two load balancers. Under normal conditions, the first server will handle the traffic. However, if the first load balancer fails or is powered off, the second will take over. This step is not strictly necessary but eliminates the risk of a Single Point of Failure.</p>
<p>This setup ensures our infrastructure remains operational even if one of the servers goes offline.</p>
<p>The two Load Balancers will be configured with the floating IP <code>192.168.1.200</code>.<br />
Our Application or Web Servers must be configured identically so that users will never know which server they are connected to.</p>
<p>For this example, we will install Apache and MariaDB on each App/Web server.</p>
<p>We will also install a Galera cluster to establish MariaDB clustering. This ensures that any database change on one server is replicated to the others.</p>
<p>First, we will load balance the web server, then we will load balance the MariaDB database usage. This will demonstrate that you can load balance virtually any kind of software.</p>
<p>Users will only see the floating IP (<code>192.168.1.200</code>) of the Load Balancers and will not be aware of the other servers or their IPs.</p>
<h3>0.4. Sources:</h3>
<ul>
<li><a href="https://www.haproxy.org/">www.haproxy.org</a>  </li>
<li><a href="https://www.server-world.info/en/note?os=Ubuntu_20.04&amp;p=haproxy&amp;f=1">www.server-world.info</a>  </li>
<li><a href="https://docs.haproxy.org/">HAProxy Documentation</a>  </li>
<li>Book: ISBN: 9781519073846 <strong>Load Balancing with HAProxy</strong> by Nick Ramirez</li>
</ul>
<p><br></p>
</details>
<details>
<summary>
1. Install and Configure Load Balancers
</summary>
<hr />
<p><strong>Install Keepalived (on srvlb1 and srvlb2)</strong></p>
<pre><code>sudo apt update
sudo apt install keepalived --yes
</code></pre>
<p><strong>Configure Keepalived on the First Load Balancer (srvlb1)</strong></p>
<p>Create a configuration file:</p>
<pre><code>sudo nano /etc/keepalived/keepalived.conf
</code></pre>
<p>Fill it with the following content. Remember to replace <code>enp0s3</code> with your actual network adapter name.</p>
<pre><code>global_defs {
    router_id node1
}
vrrp_instance VI_1 {
    state MASTER
    interface enp0s3
    virtual_router_id 51
    priority 100
    advert_int 5
    virtual_ipaddress {
    192.168.1.200
    }
}
</code></pre>
<p><strong>Configure Keepalived on the Second Load Balancer (srvlb2)</strong></p>
<p>Create a configuration file:</p>
<pre><code>sudo nano /etc/keepalived/keepalived.conf
</code></pre>
<p>Fill it with the following content. Again, remember to replace <code>enp0s3</code> with your network adapter name.</p>
<pre><code>global_defs {
    router_id node2
}
vrrp_instance VI_1 {
    state BACKUP
    interface enp0s3
    virtual_router_id 51
    priority 90
    advert_int 5
    virtual_ipaddress {
    192.168.1.200
    }
}
</code></pre>
<p><strong>Start Keepalived on Both Load Balancers (srvlb1 and srvlb2)</strong></p>
<pre><code>sudo systemctl start keepalived
</code></pre>
<p>You can check the status of Keepalived with:</p>
<pre><code>sudo systemctl status -l keepalived
</code></pre>
<p><strong>Install HAProxy on Both Load Balancers (srvlb1 and srvlb2)</strong></p>
<pre><code>sudo apt install haproxy --yes
</code></pre>
<p>Stop the service for now; we will restart it after configuration:</p>
<pre><code>sudo systemctl stop haproxy
</code></pre>
<p><br></p>
</details>
<details>
<summary>
2. Install and Configure Application/Web Servers
</summary>
<hr />
<h3>2.1. Install and Configure Apache</h3>
<p>Install Apache, MariaDB, and Galera Cluster on all App/Web servers (srvaw1, srvaw2, and srvaw3):</p>
<pre><code>sudo apt update
sudo apt install apache2 mariadb-server galera-4 --yes
</code></pre>
<p>Create a default web page for each server. For testing purposes, we'll include the server name to identify which server is responding. In a production environment, these files would be identical.</p>
<p>Delete the original file and create a new one on each server (srvaw1, srvaw2, and srvaw3):</p>
<pre><code>sudo rm /var/www/html/index.html
sudo nano /var/www/html/index.html
</code></pre>
<p><strong>For srvaw1:</strong></p>
<pre><code>&lt;html&gt;
&lt;title&gt;SrvAW1&lt;/title&gt;
&lt;body&gt;
&lt;h1&gt;SrvAW1&lt;/h1&gt;
&lt;p&gt;Empty yet.&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p><strong>For srvaw2:</strong></p>
<pre><code>&lt;html&gt;
&lt;title&gt;SrvAW2&lt;/title&gt;
&lt;body&gt;
&lt;h1&gt;SrvAW2&lt;/h1&gt;
&lt;p&gt;Empty yet.&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p><strong>For srvaw3:</strong></p>
<pre><code>&lt;html&gt;
&lt;title&gt;SrvAW3&lt;/title&gt;
&lt;body&gt;
&lt;h1&gt;SrvAW3&lt;/h1&gt;
&lt;p&gt;Empty yet.&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p><strong>Apache Configuration for Logs</strong></p>
<p><strong>Apache Configuration for Logs</strong></p>
<p>Since web access is forwarded through the load balancer, the App/Web servers will see the Load Balancer's IP as the client IP. As a result, all access and error logs will show the LB's IP instead of the real client IP. To log the correct client IPs, some configuration is required.</p>
<p>Enable the Apache2 <code>remoteip</code> module on all App/Web servers (srvaw1, srvaw2, and srvaw3):</p>
<pre><code>sudo a2enmod remoteip
</code></pre>
<p>Configure Apache to use the <code>X-Forwarded-For</code> header (added by the load balancer) in its logs.</p>
<p>Edit the Apache configuration file on all app/web servers (srvaw1, srvaw2, and srvaw3):</p>
<pre><code>sudo nano /etc/apache2/apache2.conf
</code></pre>
<p>Around line 212, add the first two lines and modify the next two lines as shown below. Remember to use your LB IPs.</p>
<pre><code>RemoteIPHeader X-Forwarded-For
RemoteIPInternalProxy 192.168.1.201 192.168.1.202
LogFormat &quot;%v:%p %a %l %u %t \&quot;%r\&quot; %&gt;s %O \&quot;%{Referer}i\&quot; \&quot;%{User-Agent}i\&quot;&quot; vhost_combined
LogFormat &quot;%a %l %u %t \&quot;%r\&quot; %&gt;s %O \&quot;%{Referer}i\&quot; \&quot;%{User-Agent}i\&quot;&quot; combined
</code></pre>
<p>Restart Apache on all app/web servers (srvaw1, srvaw2, and srvaw3):</p>
<pre><code>sudo systemctl restart apache2
</code></pre>
<h3>2.2. Configure Mariadb on App/Web Servers (srvaw1, srvaw2, and srvaw3)</h3>
<p><strong>Secure Mariadb Installations</strong> </p>
<p>Run the security script to apply basic security settings to MariaDB (srvaw1, srvaw2, and srvaw3):</p>
<pre><code>sudo mariadb-secure-installation
</code></pre>
<p>You will be asked a series of questions. Here are recommended answers:</p>
<ul>
<li>
<p><code>Enter current password for root (enter for none):</code><br />
  Press <strong>Enter</strong> as there is no password set yet.</p>
</li>
<li>
<p><code>Switch to unix_socket authentication [Y/n]</code><br />
  The root account is already protected on Debian/Ubuntu. You can answer <strong><code>n</code></strong>.</p>
</li>
<li>
<p><code>Change the root password? [Y/n]</code><br />
  For the same reason, you can answer <strong><code>n</code></strong>.</p>
</li>
<li>
<p>For the remaining questions (remove anonymous users, disallow root login remotely, remove test database, reload privilege tables), it is safe to accept the defaults by pressing <strong><code>Y</code></strong>.</p>
</li>
</ul>
<p><strong>Create a MariaDB User for Remote Access</strong></p>
<p>Create a user for testing from your workstation. Remember to use your LB IPs and a secure password. Run this on all App/Web servers (srvaw1, srvaw2, and srvaw3):</p>
<pre><code>sudo mariadb
</code></pre>
<p>In the MariaDB shell, execute:</p>
<pre><code>GRANT ALL ON *.* TO 'admin'@'192.168.1.201' IDENTIFIED BY 'Password12';
GRANT ALL ON *.* TO 'admin'@'192.168.1.202' IDENTIFIED BY 'Password12';
FLUSH PRIVILEGES;
EXIT;
</code></pre>
<p><strong>Configure Galera cluster</strong>*</p>
<p>Temporarily stop MariaDB on all app/web servers before configuration (srvaw1, srvaw2, and srvaw3):</p>
<pre><code>sudo systemctl stop mariadb
</code></pre>
<p>Configure MariaDB to listen on all interfaces. This is necessary for the cluster and will also allow connections from your workstation.</p>
<p>Edit the configuration file on all app/web servers (srvaw1, srvaw2, and srvaw3):</p>
<pre><code>sudo nano /etc/mysql/mariadb.conf.d/50-server.cnf
</code></pre>
<p>Find the following line (around lines 27-30):</p>
<pre><code>bind-address = 127.0.0.1
</code></pre>
<p>Change it to:</p>
<pre><code>bind-address = 0.0.0.0
</code></pre>
<p>Create a new configuration file for the cluster on all app/web servers (srvaw1, srvaw2, and srvaw3):</p>
<pre><code>sudo nano /etc/mysql/mariadb.conf.d/99-cluster.cnf
</code></pre>
<p>Fill it with the following content, replacing the IP addresses with your own:</p>
<pre><code>[galera]
innodb_autoinc_lock_mode = 2
wsrep_cluster_name    = &quot;x386_cluster&quot;
wsrep_cluster_address = &quot;gcomm://192.168.1.203,192.168.1.204,192.168.1.205&quot;
wsrep_provider = /usr/lib/galera/libgalera_smm.so
wsrep_provider_options = &quot;evs.suspect_timeout=PT10S&quot;
wsrep_on = on 
default_storage_engine = InnoDB 
innodb_doublewrite = 1 
binlog_format = ROW
</code></pre>
<p><strong>Start the Galera Cluster</strong></p>
<p>Initialize the cluster on the first App/Web server (srvaw1):</p>
<pre><code>sudo galera_new_cluster
</code></pre>
<p>This command will start MariaDB on this node.</p>
<p>Now start MariaDB on the other nodes (srvaw2 and srvaw3):</p>
<pre><code>sudo systemctl start mariadb
</code></pre>
<p><br></p>
</details>
<details>
<summary>
3. Configure Web Server Load Balancing 
</summary>
<hr />
<p>We will configure HAProxy to load balance the three web servers (192.168.1.203, 192.168.1.204, and 192.168.1.205).</p>
<p><strong>Configure HAProxy on both Load Balancers (srvlb1 and srvlb2):</strong></p>
<pre><code>sudo nano /etc/haproxy/haproxy.cfg
</code></pre>
<p>Add the following configuration to the end of the file:</p>
<pre><code># define frontend for apache
frontend fe_http_80
        # listen to port 80
        bind *:80
        # set the backend
        default_backend    be_http_80
        # send X-Forwarded-For header
        option   forwardfor
# define backend for apache
backend be_http_80
        # use roundrobin algorithm for balancing
        balance  roundrobin
        # define backend servers
        server   srvaw1 192.168.1.203:80 check
        server   srvaw2 192.168.1.204:80 check
        server   srvaw3 192.168.1.205:80 check
</code></pre>
<p><strong>Restart HAProxy on both Load Balancers (srvlb1 and srvlb2):</strong></p>
<pre><code>sudo systemctl restart haproxy
</code></pre>
<p><strong>Explanations</strong></p>
<ul>
<li><strong>Frontend:</strong> Handles incoming connections to the Load Balancer (LB).</li>
<li><strong>Backend:</strong> Defines the pool of servers to which connections are forwarded.</li>
</ul>
<p>Let's break down the configuration:</p>
<ul>
<li>
<p><code>frontend fe_http_80</code>
    Defines a frontend and labels it <code>fe_http_80</code>. You can use any descriptive name.</p>
</li>
<li>
<p><code>bind *:80</code>
    Instructs HAProxy to listen for incoming connections on all IP addresses of the LB on port 80.</p>
</li>
<li>
<p><code>default_backend be_http_80</code>
    Specifies that incoming traffic for this frontend should be sent to the backend named <code>be_http_80</code>.</p>
</li>
<li>
<p><code>option forwardfor</code>
    Captures the client's IP address and adds it to an <code>X-Forwarded-For</code> HTTP header. This allows Apache to log the real client IP instead of the LB's IP.</p>
</li>
<li>
<p><code>backend be_http_80</code>
    Defines the backend named <code>be_http_80</code>.</p>
</li>
<li>
<p><code>balance roundrobin</code>
    Uses the Round Robin algorithm for load balancing. This means requests are distributed to the backend servers one after the other in a circular order. Other algorithms will be explained in Section 5.</p>
</li>
<li>
<p><code>server srvaw1 192.168.1.203:80 check</code>
    <code>server srvaw2 192.168.1.204:80 check</code>
    <code>server srvaw3 192.168.1.205:80 check</code>
    These lines list the backend servers. <code>srvaw1</code>, <code>srvaw2</code>, and <code>srvaw3</code> are labels. The IP and port specify where to forward the traffic. The <code>check</code> parameter instructs the LB to perform health checks on the backend server to see if it is alive. Other parameters will be explained in Section 5.</p>
</li>
</ul>
<p><strong>Testing</strong></p>
<p>You can now connect to the website at <code>http://192.168.1.200</code> from different workstations. You should see that connections are being distributed across <code>192.168.1.203</code>, <code>192.168.1.204</code>, and <code>192.168.1.205</code>.</p>
<p><br></p>
</details>
<details>
<summary>
4. Configure Mariadb Load Balancing
</summary>
<hr />
<p><strong>Notes:</strong></p>
<p>Load Balancing an application is similar to load balancing a web server. </p>
<p>The key is to identify the TCP/IP port the application uses and configure HAProxy accordingly. For MariaDB, which uses port 3306, we will use the <code>mode tcp</code> directive in both the frontend and backend sections. This instructs HAProxy to perform Layer 4 (TCP) load balancing instead of Layer 7 (HTTP).</p>
<p><strong>Configure HAProxy on both Load Balancers (srvlb1 and srvlb2):</strong></p>
<pre><code>sudo nano /etc/haproxy/haproxy.cfg
</code></pre>
<p>Add the following configuration to the end of the file:</p>
<pre><code># define frontend for mariadb
frontend fe_mariadb_3306
        mode            tcp
        # listen to port 3306
        bind *:3306
        # set the backend
        default_backend    be_mariadb_3306
# define backend for mariadb
backend be_mariadb_3306
        mode            tcp
        # use roundrobin algorithm for balancing
        balance  roundrobin
        # define backend servers
        server   srvaw1 192.168.1.203:3306 check
        server   srvaw2 192.168.1.204:3306 check
        server   srvaw3 192.168.1.205:3306 check
</code></pre>
<p>We can reload the configuration to apply these changes without interrupting the existing web server load balancing:</p>
<pre><code>sudo systemctl reload haproxy
</code></pre>
<p><strong>Testing</strong></p>
<p>You can connect from your workstation using the following command.</p>
<p><strong>Remember:</strong> You need to have the <code>mariadb-client</code> package installed on your workstation.</p>
<p>Use the password you set in section 2.2.</p>
<pre><code>mariadb -u admin -p -h 192.168.1.200
</code></pre>
<p>Once connected to the MariaDB shell, you can run the following command to identify which server you are connected to:</p>
<pre><code>SHOW VARIABLES LIKE 'hostname';
</code></pre>
<p><br></p>
</details>
<details>
<summary>
5. More on HAProxy Configuration Options
</summary>
<hr />
<h3>5.1. Default Configuration File</h3>
<p>The default configuration file is <code>/etc/haproxy/haproxy.cfg</code>. Its initial contents are similar to the following:</p>
<pre><code>global
        log /dev/log    local0
        log /dev/log    local1 notice
        chroot /var/lib/haproxy
        stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
        stats timeout 30s
        user haproxy
        group haproxy
        daemon
        # Default SSL material locations
        ca-base /etc/ssl/certs
        crt-base /etc/ssl/private
        # See: https://ssl-config.mozilla.org/#server=haproxy&amp;serve...
        ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDH...
        ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AE...
        ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
defaults
        log     global
        mode    http
        option  httplog
        option  dontlognull
        timeout connect 5000
        timeout client  50000
        timeout server  50000
        errorfile 400 /etc/haproxy/errors/400.http
        errorfile 403 /etc/haproxy/errors/403.http
        errorfile 408 /etc/haproxy/errors/408.http
        errorfile 500 /etc/haproxy/errors/500.http
        errorfile 502 /etc/haproxy/errors/502.http
        errorfile 503 /etc/haproxy/errors/503.http
        errorfile 504 /etc/haproxy/errors/504.http
</code></pre>
<h3>5.2. Explanation of Default Config Parameters</h3>
<p><strong><code>global</code> Section</strong></p>
<ul>
<li><strong><code>log</code></strong>: Configures logging for requests and errors. These settings usually do not need to be changed.</li>
<li><strong><code>chroot</code></strong>: Enhances security by running HAProxy in a isolated directory, preventing access to other parts of the filesystem.</li>
<li><strong><code>stats</code></strong>: Enables the HAProxy statistics socket for command-line access and sets its timeout value.</li>
<li><strong><code>user</code></strong> and <strong><code>group</code></strong>: Define the system user and group under which the HAProxy process runs.</li>
<li><strong><code>daemon</code></strong>: Runs HAProxy as a background daemon.</li>
<li><strong><code>ca-base</code></strong> and <strong><code>crt-base</code></strong>: Define the default directories for TLS (SSL) certificates, which are used when load balancing HTTPS sites.</li>
<li>The three <strong><code>ssl-default-...</code></strong> options specify the default ciphers and protocols for SSL/TLS configuration.</li>
</ul>
<p>Many more parameters are available. For a full reference, see: <a href="https://cbonte.github.io/haproxy-dconv/2.3/configuration.html#3">cbonte.github.io/haproxy-dconv</a></p>
<p><strong><code>defaults</code> Section</strong></p>
<ul>
<li><strong><code>log global</code></strong>: Specifies that subsequent definitions will use the logging options set in the <code>global</code> section.</li>
<li><strong><code>mode http</code></strong>: Sets the default load balancing mode to Layer 7 (HTTP). We overrode this with <code>mode tcp</code> for MariaDB to use Layer 4 (TCP) load balancing.</li>
<li><strong><code>option httplog</code></strong>: Enables verbose logging for HTTP requests.</li>
<li><strong><code>option dontlognull</code></strong>: Ignores and does not log connections that send no data.</li>
<li><strong>Timeout directives</strong> (values in milliseconds):<ul>
<li><strong><code>timeout connect</code></strong>: Maximum time to wait for a connection to a backend server to be established.</li>
<li><strong><code>timeout client</code></strong>: Maximum time to wait for client data.</li>
<li><strong><code>timeout server</code></strong>: Maximum time to wait for a response from a backend server.</li>
</ul>
</li>
<li><strong><code>errorfile</code></strong>: Defines the HTML files to be served when HAProxy encounters specific errors. These files can be customized.</li>
</ul>
<p><strong><code>frontend</code> Section</strong></p>
<p>This section defines the part of the Load Balancer that users connect to. Here, you define the listening IPs and ports and reference the backend section where requests should be forwarded.</p>
<p><strong><code>backend</code> Section</strong></p>
<p>This section defines the pool of servers (IPs and ports) to which requests are forwarded. You can also define the load balancing algorithm, mode, and other server-specific parameters here.</p>
<p><strong><code>listen</code> Section</strong></p>
<p>This is a third type of section that combines the <code>frontend</code> and <code>backend</code> definitions into a single block. It is useful for simpler configurations. Here is a basic example:</p>
<pre><code>listen myproxy
     bind *:80
     server srv1 192.168.1.181:80
</code></pre>
<p><br></p>
</details>
<details>
<summary>
6. Load Balancing Algorithms
</summary>
<hr />
<p>HAProxy supports several load balancing algorithms. Here are the most common ones:</p>
<ul>
<li><strong>Round Robin:</strong> Distributes traffic equally among servers in sequence.</li>
<li><strong>Weighted Round Robin:</strong> Distributes traffic based on assigned server weights.</li>
<li><strong>Leastconn:</strong> Sends new connections to the server with the least number of current connections.</li>
<li><strong>Weighted Leastconn:</strong> Sends new connections to the server with the lowest (connections/weight) ratio.</li>
<li><strong>Hash (URI):</strong> Uses a hash of the request (e.g., the URI) to always send the same type of request to the same server.</li>
<li><strong>First Available:</strong> Each server accepts a defined number of connections sequentially.</li>
</ul>
<h3>6.1. Round Robin Algorithm</h3>
<p>We used this algorithm for our Apache and MariaDB load balancers. It is a simple method to distribute traffic equally by forwarding requests to each server in turn.</p>
<p><strong>Example frontend and backend configuration:</strong></p>
<pre><code>frontend fe_http_80
        bind *:80
        default_backend    be_http_80
backend be_http_80
        balance  roundrobin
        server   srv1 192.168.1.203:80 check
        server   srv2 192.168.1.204:80 check
        server   srv3 192.168.1.205:80 check
</code></pre>
<h3>6.2. Weighted Round Robin Algorithm</h3>
<p>Weighted Round Robin is similar to the standard Round Robin but allows you to assign weights to backend servers. This is useful when some servers have more processing power and should handle a larger share of the traffic.</p>
<p><strong>Example configuration where <code>srv1</code> and <code>srv2</code> handle twice as much traffic as <code>srv3</code>:</strong></p>
<pre><code>frontend fe_http_80
        bind *:80
        default_backend    be_http_80
backend be_http_80
        balance  roundrobin
        server   srv1 192.168.1.202:80 weight 2 check
        server   srv2 192.168.1.203:80 weight 2 check
        server   srv3 192.168.1.204:80 weight 1 check
</code></pre>
<p>You can temporarily disable a backend server using the <code>disabled</code> keyword:</p>
<pre><code>        server   srv3 192.168.1.204:80 weight 1 disabled
</code></pre>
<h3>6.3. Leastconn Algorithm</h3>
<p>The Leastconn algorithm distribributes traffic to the server with the fewest active connections. This is particularly useful for load balancing long-lived connections, such as with databases.</p>
<p><strong>Example frontend and backend configuration:</strong></p>
<pre><code>frontend fe_mariadb_3306
        mode            tcp
        bind *:3306
        default_backend    be_mariadb_3306
backend be_mariadb_3306
        mode            tcp
        balance  leastconn
        server   srv1 192.168.1.203:3306 check
        server   srv2 192.168.1.204:3306 check
        server   srv3 192.168.1.205:3306 check
</code></pre>
<p>With this algorithm, a newly added server might immediately receive all new traffic because it has zero connections. To avoid this, use the <code>slowstart</code> parameter followed by a time period:</p>
<pre><code>        server   srv4 192.168.1.232:3306 check slowstart 60s
</code></pre>
<h3>6.4. Weighted Leastconn Algorithm</h3>
<p>Weighted Leastconn is similar to the standard Leastconn algorithm but incorporates server weights. Servers with a higher weight will be able to handle more connections relative to their capacity.</p>
<p><strong>Example configuration where <code>srv1</code> and <code>srv2</code> can handle twice as many connections as <code>srv3</code>:</strong></p>
<pre><code>frontend fe_mariadb_3306
        mode            tcp
        bind *:3306
        default_backend    be_mariadb_3306
backend be_mariadb_3306
        mode            tcp
        balance  leastconn
        server   srv1 192.168.1.203:3306 weight 2 check
        server   srv2 192.168.1.204:3306 weight 2 check
        server   srv3 192.168.1.205:3306 weight 1 check
</code></pre>
<h3>6.5. HASH Uri Algorithm</h3>
<p>This algorithm is highly useful for load balancing static web servers with caching. It hashes the request URI (or part of it) to ensure the same request is always forwarded to the same backend server, thereby increasing cache hits and performance.</p>
<p><strong>Example frontend and backend configuration:</strong></p>
<pre><code>frontend fe_http_80
        bind *:80
        default_backend    be_http_80
backend be_http_80
        balance  uri
        server   srv1 192.168.1.203:80 check
        server   srv2 192.168.1.204:80 check
        server   srv3 192.168.1.205:80 check
</code></pre>
<p>This algorithm can also be used in weighted mode to better utilize faster servers.</p>
<p><strong>Example with weights, where <code>srv1</code> and <code>srv2</code> handle more traffic:</strong></p>
<pre><code>frontend fe_http_80
        bind *:80
        default_backend    be_http_80
backend be_http_80
        balance  uri
        server   srv1 192.168.1.202:80 weight 2 check
        server   srv2 192.168.1.203:80 weight 2 check
        server   srv3 192.168.1.204:80 weight 1 check
</code></pre>
<h3>6.6. First Available Algorithm</h3>
<p>This algorithm uses servers sequentially. It directs connections to the first server until it reaches a specified maximum connection count, then moves to the next server. This can be useful for cost-saving when you don't want to spin up additional servers unless necessary.</p>
<p><strong>Example configuration where each server handles up to 50 connections:</strong></p>
<pre><code>frontend fe_http_80
        bind *:80
        default_backend    be_http_80
backend be_http_80
        balance  first
        server   srv1 192.168.1.203:80 maxconn 50
        server   srv2 192.168.1.204:80 maxconn 50
        server   srv3 192.168.1.205:80 maxconn 50
</code></pre>
<p><br></p>
</details>
<details>
<summary>
7. URL Redirection
</summary>
<hr />
<p>HAProxy can redirect requests based on the URL path, URL parameters, HTTP headers, or the HTTP host address. This functionality can significantly optimize traffic handling in various scenarios.</p>
<h3>7.1. URL Path Redirection</h3>
<p><strong>Scenario</strong></p>
<p>Assume we have three folders on our web servers: <code>folder1</code>, <code>folder2</code>, and <code>folder3</code>. We want to redirect requests for <code>folder1</code> to <code>srvaw1</code>, <code>folder2</code> to <code>srvaw2</code>, and <code>folder3</code> to <code>srvaw3</code>. All other traffic should be load-balanced as defined in Section 3.</p>
<p><strong>Configuration</strong></p>
<p>Edit the HAProxy configuration file on the load balancers:</p>
<pre><code>sudo nano /etc/haproxy/haproxy.cfg
</code></pre>
<p>Remove the previously added backend and frontend sections for HTTP and add the following to the end of the file:</p>
<pre><code>frontend fe_http_80
    bind *:80
    acl acl_folder1 path_beg -i /folder1
    use_backend be_folder1 if acl_folder1
    acl acl_folder2 path_beg -i /folder2
    use_backend be_folder2 if acl_folder2
    acl acl_folder3 path_beg -i /folder3
    use_backend be_folder3 if acl_folder3
    default_backend    be_http_80
        option   forwardfor
backend be_folder1
        server   srvaw1 192.168.1.203:80 check
backend be_folder2
        server   srvaw2 192.168.1.204:80 check
backend be_folder3
        server   srvaw3 192.168.1.205:80 check
backend be_http_80
        balance  roundrobin
        server   srvaw1 192.168.1.203:80 check
        server   srvaw2 192.168.1.204:80 check
        server   srvaw3 192.168.1.205:80 check
</code></pre>
<p><strong>Restart or Reload HAProxy</strong></p>
<p>To apply the changes, you can restart HAProxy:</p>
<pre><code>sudo systemctl restart haproxy
</code></pre>
<p>If HAProxy is already active and you want to avoid dropping connections, reload it instead:</p>
<pre><code>sudo systemctl reload haproxy
</code></pre>
<p><strong>Explanations</strong></p>
<p>ACLs (Access Control Lists) are used to define conditions for matching requests.</p>
<ul>
<li><code>acl acl_folder1 path_beg -i /folder1</code><ul>
<li><code>acl</code> is the keyword to define an ACL.</li>
<li><code>acl_folder1</code> is the name given to this ACL.</li>
<li><code>path_beg</code> is the condition, meaning the URL path begins with the following string.</li>
<li><code>-i</code> makes the string match case-insensitive.</li>
<li><code>/folder1</code> is the string we are looking for.</li>
</ul>
</li>
</ul>
<p>The ACL <code>acl_folder1</code> is activated when a URL path starts with <code>/folder1</code>, for example:<br />
<code>http://www.386387.xyz/folder1</code></p>
<p>For a URL like <code>http://www.386387.xyz/folder1/folder2/folder3</code>, the URL Path is <code>/folder1/folder2/folder3</code>.</p>
<ul>
<li><code>use_backend be_folder1 if acl_folder1</code>
    This directive instructs HAProxy to use the servers in the <code>be_folder1</code> backend when <code>acl_folder1</code> is activated.</li>
</ul>
<p>Similar ACLs and backends are created for <code>/folder2</code> and <code>/folder3</code>.</p>
<p>There are other conditions for matching URL paths. Here is a list:</p>
<ul>
<li><code>path</code>: Exact URL path match.</li>
<li><code>path_beg</code>: URL path begins with the string.</li>
<li><code>path_end</code>: URL path ends with the string.</li>
<li><code>path_sub</code>: URL path contains the string as a substring.</li>
<li><code>path_dir</code>: URL path has the string as a subdirectory.</li>
<li><code>path_len</code>: Exact length of the URL path.</li>
<li><code>path_reg</code>: Regex match of the URL path.</li>
</ul>
<p><strong>URL Path ACL Examples</strong></p>
<p>An ACL for an exact info page:</p>
<pre><code>acl acl_info path -i /info/info.html
</code></pre>
<p>An ACL for JPG and PNG images:</p>
<pre><code>acl acl_image path_end .jpg .png
</code></pre>
<p>An ACL for image directories:</p>
<pre><code>acl acl_image2 path_dir -i /images
</code></pre>
<p>An ACL for URL paths longer than 20 characters:</p>
<pre><code>acl acl_long path_len gt 20
</code></pre>
<p>An ACL for paths containing "cart":</p>
<pre><code>acl acl_cart path_sub -i cart
</code></pre>
<p>An ACL for images using a regular expression:</p>
<pre><code>acl acl_image3 path_reg (jpg|jpeg|bmp|gif|png)
</code></pre>
<h3>7.2. URL Parameter Redirection</h3>
<p>A URL parameter is a key-value pair (e.g., <code>variable=value</code>). Many websites, like Google and DuckDuckGo, use them. For example:<br />
<code>https://www.example.org/?s=searchterm</code></p>
<p>Here, <code>s</code> is the variable (for "search") and <code>searchterm</code> is the value. HAProxy can capture these parameters and redirect specific key-value pairs to different backends.</p>
<p><strong>Example</strong></p>
<p>Assume we have a parameter named <code>block_number</code> with possible values: <code>first</code>, <code>second</code>, <code>third</code>, and <code>rest</code>. A URL for the first block would look like:<br />
<code>http://www.386387.xyz/?block_number=first</code></p>
<p>We want to redirect:
*   <code>first</code> to one backend.
*   <code>second</code> and <code>third</code> to another backend.
*   <code>rest</code> to a third backend.</p>
<p>A sample frontend configuration would be:</p>
<pre><code>frontend fe_blocks
    bind *:80
    acl acl_block1 url_param(block_number) -i -m str first
    use_backend be_block1 if acl_block1
    acl acl_block23 url_param(block_number) -i -m str second third
    use_backend be_block23 if acl_block23
    acl acl_blockrest url_param(block_number) -i -m str rest
    use_backend be_blockrest if acl_blockrest
    default_backend blocks
</code></pre>
<p>The <code>-i</code> directive enables case-insensitive matching. The <code>-m str</code> directive enables exact string matching for the values provided.</p>
<h3>7.3. HTTP Header Redirection</h3>
<p>HTTP headers contain information such as <code>User-Agent</code>, <code>Host</code> (the website address), <code>Content-Type</code>, and <code>Referer</code>. For a full list, please refer to:<br />
<a href="https://en.wikipedia.org/wiki/List_of_HTTP_header_fields">https://en.wikipedia.org/wiki/List_of_HTTP_header_fields</a></p>
<p>A <code>User-Agent</code> header might look like this:<br />
<code>Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:87.0) Gecko/20100101 Firefox/87.0</code></p>
<p>A <code>Host</code> header might look like this:<br />
<code>Host: www.386387.xyz</code></p>
<p><strong>Example: Redirecting Mobile Traffic</strong></p>
<p>The following frontend configuration redirects requests from mobile devices to a specific backend based on the <code>User-Agent</code> header.</p>
<pre><code>frontend be_http
    bind *:80
    acl acl_mobile req.hdr(User-Agent) -i -m reg (android|iphone)
    use_backend be_mobile if acl_mobile
    default_backend be_http
</code></pre>
<p><br></p>
</details>
<details>
<summary>
8. Enabling HTTPS at HAProxy
</summary>
<hr />
<p>This section covers enabling HTTPS in HAProxy using free TLS (SSL) certificates from Let's Encrypt, managed by the Certbot tool for automatic renewals every 90 days.</p>
<p>All steps described here have been tested. Since Let's Encrypt requires internet-accessible servers for domain validation, this section uses VPS servers. For simplicity, we'll use a single HAProxy server and two web servers (without Keepalived).</p>
<h3>8.0. Configurations &amp; Considerations (For this section only)</h3>
<p><strong>Server Setup:</strong></p>
<ul>
<li><code>www.386387.xyz</code>: Load Balancer  <code>159.203.70.143</code></li>
<li><code>srv1.386387.xyz</code>: Web Server 1  <code>64.225.29.174</code></li>
<li><code>srv2.386387.xyz</code>: Web Server 2  <code>165.227.176.14</code></li>
</ul>
<p>Tested on Debian 13/12 and Ubuntu 24.04/22.04 LTS Servers.</p>
<p>We start with freshly installed servers.</p>
<p><strong>Challenge:</strong> To obtain and renew Let's Encrypt certificates with Certbot, a web server must be accessible on port 80. However, HAProxy also needs to bind to port 80. This creates a conflict.</p>
<p><strong>Solution:</strong> We install Apache on the Load Balancer but bind it only to the loopback interface (<code>127.0.0.1</code>). HAProxy will bind to the server's public IPs. We then configure HAProxy to redirect Let's Encrypt validation requests (to the <code>/.well-known/acme-challenge</code> directory) to the local Apache instance. This allows both Apache and HAProxy to coexist on port 80.</p>
<h3>8.1. Initial Installs</h3>
<p><strong>Install HAProxy on the Load Balancer (<code>www.386387.xyz</code>):</strong></p>
<pre><code>sudo apt update
sudo apt install haproxy --yes
sudo systemctl stop haproxy
</code></pre>
<p><strong>Install Apache on the Web Servers (<code>srv1.386387.xyz</code> and <code>srv2.386387.xyz</code>):</strong></p>
<pre><code>sudo apt update
sudo apt install apache2 --yes
</code></pre>
<p><strong>Create a test page on each web server:</strong></p>
<pre><code>sudo rm /var/www/html/index.html
sudo nano /var/www/html/index.html
</code></pre>
<p><strong>For <code>srv1.386387.xyz</code>:</strong></p>
<pre><code>&lt;html&gt;
&lt;title&gt;SrvAW1&lt;/title&gt;
&lt;body&gt;
&lt;h1&gt;Srv1&lt;/h1&gt;
&lt;p&gt;Empty yet.&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p><strong>For <code>srv2.386387.xyz</code>:</strong></p>
<pre><code>&lt;html&gt;
&lt;title&gt;SrvAW1&lt;/title&gt;
&lt;body&gt;
&lt;h1&gt;Srv2&lt;/h1&gt;
&lt;p&gt;Empty yet.&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3>8.2. Install and Configure Apache on the Load Balancer (Run on <code>www.386387.xyz</code>)</h3>
<pre><code>sudo apt update
sudo apt install apache2 --yes
</code></pre>
<p>Apache might fail to start due to port 80 being occupied by HAProxy. This is expected and will be resolved.</p>
<p><strong>Configure Apache to bind only to the loopback interface:</strong></p>
<pre><code>sudo nano /etc/apache2/ports.conf
</code></pre>
<p>Modify the file to look like this:</p>
<pre><code>Listen 127.0.0.1:80
&lt;IfModule ssl_module&gt;
        Listen 127.0.0.1:443
&lt;/IfModule&gt;
&lt;IfModule mod_gnutls.c&gt;
        Listen 127.0.0.1:443
&lt;/IfModule&gt;
</code></pre>
<p><strong>Configure the default virtual host:</strong></p>
<pre><code>sudo nano /etc/apache2/sites-available/000-default.conf
</code></pre>
<p>Update the file with your domain(s):</p>
<pre><code>&lt;VirtualHost 127.0.0.1:80&gt;
        ServerAdmin webmaster@localhost
        ServerName www.386387.xyz
        ServerAlias 386387.xyz
        DocumentRoot /var/www/html
        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined
&lt;/VirtualHost&gt;
</code></pre>
<p><strong>Create the Let's Encrypt challenge directory:</strong></p>
<pre><code>sudo mkdir -p /var/www/html/.well-known/acme-challenge
</code></pre>
<p><strong>Restart Apache:</strong></p>
<pre><code>sudo systemctl restart apache2
</code></pre>
<h3>8.3. Configure HAProxy to Redirect to Apache (Run on <code>www.386387.xyz</code>)</h3>
<p>Edit the HAProxy configuration file</p>
<pre><code>sudo nano /etc/haproxy/haproxy.cfg
</code></pre>
<p>Add the following to the end of the file. Replace the IP address in the <code>bind</code> directive with your Load Balancer's public IP (find it using <code>ip a</code>).</p>
<pre><code>frontend fe_http
        bind 159.203.70.143:80
        acl acl_acme path_beg -i /.well-known/acme-challenge
        use_backend be_acme if acl_acme
backend be_acme
        server self 127.0.0.1:80 check
</code></pre>
<p><strong>Restart HAProxy:</strong></p>
<pre><code>sudo systemctl restart haproxy
</code></pre>
<h3>8.4. Install and Run Certbot (Run on <code>www.386387.xyz</code>)</h3>
<p><strong>Install Certbot:</strong></p>
<pre><code>sudo apt update
sudo apt install --yes  certbot
</code></pre>
<p><strong>Generate certificates using the webroot plugin. Replace the domains with your own:</strong></p>
<pre><code>sudo certbot certonly --webroot --webroot-path /var/www/html \
   -d www.386387.xyz,386387.xyz
</code></pre>
<h3>8.5. Generate Certificate for HAProxy (Run on www.386387.xyz)</h3>
<p>Let's Encrypt certificates are stored in <code>/etc/letsencrypt/live/</code>. Your directory will be named after your primary domain.</p>
<p><strong>Find your certificate directory:</strong></p>
<pre><code>sudo ls -al /etc/letsencrypt/live
</code></pre>
<p>HAProxy requires the certificate and private key to be in a single file. Replace <code>www.386387.xyz</code> with your actual domain name from the command above.</p>
<pre><code>sudo -i
cd /etc/letsencrypt/live/www.386387.xyz
cat fullchain.pem privkey.pem &gt;&gt; haproxy.pem
exit
</code></pre>
<h3>8.6. Configure HAProxy (Run on www.386387.xyz)</h3>
<p>We will now update the HAProxy configuration to handle HTTPS traffic and load balance the backend servers.</p>
<pre><code>sudo nano /etc/haproxy/haproxy.cfg
</code></pre>
<p>Replace the configuration at the end of the file with the following:</p>
<pre><code>frontend fe_http
        bind 159.203.70.143:80
        bind 159.203.70.143:443 ssl crt /etc/letsencrypt/live/www.386387.xyz/haproxy.pem
        acl acl_acme path_beg -i /.well-known/acme-challenge
        use_backend be_acme if acl_acme
        default_backend    be_http
        option   forwardfor
backend be_acme
        server self 127.0.0.1:80 check
backend be_http
        balance  roundrobin
        server   srv1 64.225.29.174:80 check
        server   srv2 165.227.176.14:80 check
</code></pre>
<p><strong>Restart HAProxy:</strong></p>
<pre><code>sudo systemctl restart haproxy
</code></pre>
<p>HTTPS is now active, but we will add further refinements.</p>
<h3>8.7. Test Certificate Renewal and Add Renewal Hooks (Run on <code>www.386387.xyz</code>)</h3>
<p>Let's Encrypt certificates are valid for 90 days. Certbot can automatically renew them. Test the renewal process with a dry run:</p>
<pre><code>sudo certbot renew --dry-run
</code></pre>
<p>If this runs without errors, automatic renewal should work.</p>
<p>However, every time the certificate is renewed, we must regenerate the combined <code>haproxy.pem</code> file and reload HAProxy. We can automate this by placing a script in the Certbot renewal hooks directory.</p>
<p>Certbot executes scripts in <code>/etc/letsencrypt/renewal-hooks/deploy/</code> after a successful renewal.</p>
<p><strong>Create the hook script:</strong></p>
<pre><code>sudo nano /etc/letsencrypt/renewal-hooks/deploy/haproxy.sh
</code></pre>
<p>Add the following content, replacing the domain name with yours:</p>
<pre><code>cat /etc/letsencrypt/live/www.386387.xyz/fullchain.pem /etc/letsencrypt/live/www.386387.xyz/privkey.pem \
  &gt;&gt; /etc/letsencrypt/live/www.386387.xyz/haproxy.pem
systemctl restart haproxy
</code></pre>
<p><strong>Make the script executable:</strong></p>
<pre><code>sudo chmod +x /etc/letsencrypt/renewal-hooks/deploy/haproxy.sh
</code></pre>
<h3>8.8. Explanations</h3>
<p>At this stage, we have a fully functional HTTPS setup with automatic certificate renewal. Note that only the traffic between the client and the Load Balancer is encrypted (TLS Termination). The traffic between the Load Balancer and the web servers is still in plain HTTP.</p>
<p>For enhanced security, especially if your web servers are internet-accessible, we can encrypt this backend traffic as well using TLS Re-Encryption. We will achieve this by using self-signed certificates on the web servers and configuring HAProxy to connect to them via HTTPS.</p>
<h3>8.9. Enable HTTPS on the Web Servers (Run on <code>srv1.386387.xyz</code> and <code>srv2.386387.xyz</code>)</h3>
<p><strong>Enable the Apache SSL module:</strong></p>
<pre><code>sudo a2enmod ssl
sudo systemctl restart apache2
</code></pre>
<p><strong>Create a directory for certificates:</strong></p>
<pre><code>sudo mkdir /etc/apache2/certs
</code></pre>
<p><strong>Generate a self-signed certificate (valid for ~20 years):</strong></p>
<pre><code>sudo openssl req -x509 -nodes -days 7300 -newkey rsa:2048 \
-keyout /etc/apache2/certs/www.386387.xyz.key -out /etc/apache2/certs/www.386387.xyz.crt
</code></pre>
<p>Fill in the prompts appropriately when asked.</p>
<p><strong>Create a new virtual host configuration for SSL:</strong></p>
<pre><code>sudo nano /etc/apache2/sites-available/000-virtual-ssl.conf
</code></pre>
<p>Add the following configuration:</p>
<pre><code>&lt;IfModule mod_ssl.c&gt;
    &lt;VirtualHost *:443&gt;
        ServerName www.386387.xyz
        ServerAlias 386387.xyz
        ServerAdmin webmaster@www.386387.xyz
        DocumentRoot /var/www/html
        ErrorLog ${APACHE_LOG_DIR}/www.386387.xyz-error.log
        CustomLog ${APACHE_LOG_DIR}/www.386387.xyz-access.log combined
        SSLEngine on
        SSLCertificateFile  /etc/apache2/certs/www.386387.xyz.crt
        SSLCertificateKeyFile   /etc/apache2/certs/www.386387.xyz.key
    &lt;/VirtualHost&gt;
&lt;/IfModule&gt;
</code></pre>
<p><strong>Enable the SSL site and reload Apache:</strong></p>
<pre><code>sudo a2ensite 000-virtual-ssl.conf
sudo systemctl reload apache2
</code></pre>
<p>The web servers are now ready for HTTPS connections. The next step is to configure HAProxy to use HTTPS for backend connections.</p>
<h3>8.10. Configure HAProxy for Backend HTTPS (TLS Re-Encryption) (Run on <code>www.386387.xyz</code>)</h3>
<pre><code>sudo nano /etc/haproxy/haproxy.cfg
</code></pre>
<p>Locate the <code>backend be_http</code> section and modify the <code>server</code> lines to use port 443 and the <code>ssl</code> and <code>verify none</code> parameters (since we are using self-signed certificates):</p>
<pre><code>backend be_http
        balance  roundrobin
        server   srv1 64.225.29.174:443 check ssl verify none
        server   srv2 165.227.176.14:443 check ssl verify none
</code></pre>
<p><strong>Restart HAProxy:</strong></p>
<pre><code>sudo systemctl restart haproxy
</code></pre>
<h3>8.11. Auto HTTP to HTTPS Redirection (Run on www.386387.xyz)</h3>
<p>To ensure all traffic uses encryption, we can force HTTP requests to redirect to HTTPS.</p>
<p>Edit the HAProxy configuration:</p>
<pre><code>sudo nano /etc/haproxy/haproxy.cfg
</code></pre>
<p>In the <code>frontend fe_http</code> section, add the following <code>redirect</code> rule after the <code>bind</code> lines:</p>
<pre><code>        redirect scheme https if !{ ssl_fc }
</code></pre>
<p>The updated frontend section should look like this:</p>
<pre><code>frontend fe_http
        bind 159.203.70.143:80
        bind 159.203.70.143:443 ssl crt /etc/letsencrypt/live/www.386387.xyz/haproxy.pem
        redirect scheme https if !{ ssl_fc }
        acl acl_acme path_beg -i /.well-known/acme-challenge
        use_backend be_acme if acl_acme
        default_backend    be_http
        option   forwardfor
</code></pre>
<p><strong>Restart HAProxy:</strong></p>
<pre><code>sudo systemctl restart haproxy
</code></pre>
<h3>8.12. Server Persistence (Sticky Sessions) with Cookies</h3>
<p>For applications that require session persistence (e.g., when users are logged in), we need to ensure a client is directed to the same backend server for the duration of their session. This can be achieved using cookies.</p>
<p>Edit the HAProxy configuration:</p>
<pre><code>sudo nano /etc/haproxy/haproxy.cfg
</code></pre>
<p>Modify the <code>backend be_http</code> section to include cookie-based persistence:</p>
<pre><code>backend be_acme
        server self 127.0.0.1:80 check
backend be_http
        balance roundrobin
        cookie ACTIVESERVER insert indirect nocache
        server srv1 64.225.29.174:443 check cookie srv1 ssl verify none 
        server srv2 165.227.176.14:443 check cookie srv2 ssl verify none 
</code></pre>
<p><strong>Restart HAProxy:</strong></p>
<pre><code>sudo systemctl restart haproxy
</code></pre>
<h3>8.13. Final Contents of HAProxy Config File</h3>
<p>The final <code>/etc/haproxy/haproxy.cfg</code> file should look similar to this:</p>
<pre><code>global
        log /dev/log    local0
        log /dev/log    local1 notice
        chroot /var/lib/haproxy
        stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd lis&gt;
        stats timeout 30s
        user haproxy
        group haproxy
        daemon
        # Default SSL material locations
        ca-base /etc/ssl/certs
        crt-base /etc/ssl/private
        # See: https://ssl-config.mozilla.org/#server=haproxy&amp;server-version=2.&gt;
        ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128&gt;
        ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SH&gt;
        ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
defaults
        log     global
        mode    http
        option  httplog
        option  dontlognull
        timeout connect 5000
        timeout client  50000
        timeout server  50000
        errorfile 400 /etc/haproxy/errors/400.http
        errorfile 403 /etc/haproxy/errors/403.http
        errorfile 408 /etc/haproxy/errors/408.http
        errorfile 500 /etc/haproxy/errors/500.http
        errorfile 502 /etc/haproxy/errors/502.http
        errorfile 503 /etc/haproxy/errors/503.http
        errorfile 504 /etc/haproxy/errors/504.http
frontend fe_http
        bind 159.203.70.143:80
        bind 159.203.70.143:443 ssl crt /etc/letsencrypt/live/www.386387.xyz/haproxy.pem
        redirect scheme https if !{ ssl_fc }
        acl acl_acme path_beg -i /.well-known/acme-challenge
        use_backend be_acme if acl_acme
        default_backend    be_http
        option   forwardfor
backend be_acme
        server self 127.0.0.1:80 check
backend be_http
        balance  roundrobin
        cookie ACTIVESERVER insert indirect nocache
        server srv1 64.225.29.174:443 check cookie srv1 ssl verify none 
        server srv2 165.227.176.14:443 check cookie srv2 ssl verify none 
</code></pre>
</details><!-- HTML Footer Start -->

</body>
</html>

<!-- HTML Footer End -->
