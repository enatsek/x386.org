<!DOCTYPE html><html lang="en" dir="ltr" data-theme="dark" data-has-toc data-has-sidebar class="astro-bguv2lll"> <head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>HAProxy | Debian & Ubuntu Tutorials</title><link rel="shortcut icon" href="/./src/assets/logo.png" type="image/png"/><meta name="generator" content="Astro v5.16.6"/><meta name="generator" content="Starlight v0.37.1"/><meta property="og:title" content="HAProxy"/><meta property="og:type" content="article"/><meta property="og:locale" content="en"/><meta property="og:description" content="High-availability load balancing with SSL/TLS and keepalived"/><meta property="og:site_name" content="Debian &#38; Ubuntu Tutorials"/><meta name="twitter:card" content="summary_large_image"/><meta name="description" content="High-availability load balancing with SSL/TLS and keepalived"/><script>
	window.StarlightThemeProvider = (() => {
		const storedTheme =
			typeof localStorage !== 'undefined' && localStorage.getItem('starlight-theme');
		const theme =
			storedTheme ||
			(window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
		document.documentElement.dataset.theme = theme === 'light' ? 'light' : 'dark';
		return {
			updatePickers(theme = storedTheme || 'auto') {
				document.querySelectorAll('starlight-theme-select').forEach((picker) => {
					const select = picker.querySelector('select');
					if (select) select.value = theme;
					/** @type {HTMLTemplateElement | null} */
					const tmpl = document.querySelector(`#theme-icons`);
					const newIcon = tmpl && tmpl.content.querySelector('.' + theme);
					if (newIcon) {
						const oldIcon = picker.querySelector('svg.label-icon');
						if (oldIcon) {
							oldIcon.replaceChildren(...newIcon.cloneNode(true).childNodes);
						}
					}
				});
			},
		};
	})();
</script><template id="theme-icons"><svg aria-hidden="true" class="light astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M5 12a1 1 0 0 0-1-1H3a1 1 0 0 0 0 2h1a1 1 0 0 0 1-1Zm.64 5-.71.71a1 1 0 0 0 0 1.41 1 1 0 0 0 1.41 0l.71-.71A1 1 0 0 0 5.64 17ZM12 5a1 1 0 0 0 1-1V3a1 1 0 0 0-2 0v1a1 1 0 0 0 1 1Zm5.66 2.34a1 1 0 0 0 .7-.29l.71-.71a1 1 0 1 0-1.41-1.41l-.66.71a1 1 0 0 0 0 1.41 1 1 0 0 0 .66.29Zm-12-.29a1 1 0 0 0 1.41 0 1 1 0 0 0 0-1.41l-.71-.71a1.004 1.004 0 1 0-1.43 1.41l.73.71ZM21 11h-1a1 1 0 0 0 0 2h1a1 1 0 0 0 0-2Zm-2.64 6A1 1 0 0 0 17 18.36l.71.71a1 1 0 0 0 1.41 0 1 1 0 0 0 0-1.41l-.76-.66ZM12 6.5a5.5 5.5 0 1 0 5.5 5.5A5.51 5.51 0 0 0 12 6.5Zm0 9a3.5 3.5 0 1 1 0-7 3.5 3.5 0 0 1 0 7Zm0 3.5a1 1 0 0 0-1 1v1a1 1 0 0 0 2 0v-1a1 1 0 0 0-1-1Z"/></svg><svg aria-hidden="true" class="dark astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21.64 13a1 1 0 0 0-1.05-.14 8.049 8.049 0 0 1-3.37.73 8.15 8.15 0 0 1-8.14-8.1 8.59 8.59 0 0 1 .25-2A1 1 0 0 0 8 2.36a10.14 10.14 0 1 0 14 11.69 1 1 0 0 0-.36-1.05Zm-9.5 6.69A8.14 8.14 0 0 1 7.08 5.22v.27a10.15 10.15 0 0 0 10.14 10.14 9.784 9.784 0 0 0 2.1-.22 8.11 8.11 0 0 1-7.18 4.32v-.04Z"/></svg><svg aria-hidden="true" class="auto astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21 14h-1V7a3 3 0 0 0-3-3H7a3 3 0 0 0-3 3v7H3a1 1 0 0 0-1 1v2a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-2a1 1 0 0 0-1-1ZM6 7a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v7H6V7Zm14 10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-1h16v1Z"/></svg></template><link rel="stylesheet" href="/_astro/print.DNXP8c50.css" media="print"><link rel="stylesheet" href="/_astro/index.0vIKbS8r.css"><script type="module" src="/_astro/page.B1D-nYk3.js"></script></head> <body class="astro-bguv2lll"> <a href="#_top" class="astro-7q3lir66">Skip to content</a>  <div class="page sl-flex astro-vrdttmbt"> <header class="header astro-vrdttmbt"><div class="header astro-kmkmnagf"> <div class="title-wrapper sl-flex astro-kmkmnagf"> <a href="/" class="site-title sl-flex astro-m46x6ez3">  <img class="astro-m46x6ez3" alt src="/_astro/logo.Br7QL1LC.png" width="734" height="349">  <span class="astro-m46x6ez3" translate="no"> Debian &amp; Ubuntu Tutorials </span> </a>  </div> <div class="sl-flex print:hidden astro-kmkmnagf"> <site-search class="astro-kmkmnagf astro-v37mnknz" data-translations="{&#34;placeholder&#34;:&#34;Search&#34;}"> <button data-open-modal disabled aria-label="Search" aria-keyshortcuts="Control+K" class="astro-v37mnknz"> <svg aria-hidden="true" class="astro-v37mnknz astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21.71 20.29 18 16.61A9 9 0 1 0 16.61 18l3.68 3.68a.999.999 0 0 0 1.42 0 1 1 0 0 0 0-1.39ZM11 18a7 7 0 1 1 0-14 7 7 0 0 1 0 14Z"/></svg> <span class="sl-hidden md:sl-block astro-v37mnknz" aria-hidden="true">Search</span> <kbd class="sl-hidden md:sl-flex astro-v37mnknz" style="display: none;"> <kbd class="astro-v37mnknz">Ctrl</kbd><kbd class="astro-v37mnknz">K</kbd> </kbd> </button> <dialog style="padding:0" aria-label="Search" class="astro-v37mnknz"> <div class="dialog-frame sl-flex astro-v37mnknz">  <button data-close-modal class="sl-flex md:sl-hidden astro-v37mnknz"> Cancel </button> <div class="search-container astro-v37mnknz"> <div id="starlight__search" class="astro-v37mnknz"></div> </div> </div> </dialog> </site-search>  <script>
	(() => {
		const openBtn = document.querySelector('button[data-open-modal]');
		const shortcut = openBtn?.querySelector('kbd');
		if (!openBtn || !(shortcut instanceof HTMLElement)) return;
		const platformKey = shortcut.querySelector('kbd');
		if (platformKey && /(Mac|iPhone|iPod|iPad)/i.test(navigator.platform)) {
			platformKey.textContent = '⌘';
			openBtn.setAttribute('aria-keyshortcuts', 'Meta+K');
		}
		shortcut.style.display = '';
	})();
</script> <script type="module" src="/_astro/Search.astro_astro_type_script_index_0_lang.cjYDvRdi.js"></script>   </div> <div class="sl-hidden md:sl-flex print:hidden right-group astro-kmkmnagf"> <div class="sl-flex social-icons astro-kmkmnagf"> <a href="https://github.com/enatsek/" rel="me" class="sl-flex astro-wy4te6ga"><span class="sr-only astro-wy4te6ga">GitHub</span><svg aria-hidden="true" class="astro-wy4te6ga astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M12 .3a12 12 0 0 0-3.8 23.38c.6.12.83-.26.83-.57L9 21.07c-3.34.72-4.04-1.61-4.04-1.61-.55-1.39-1.34-1.76-1.34-1.76-1.08-.74.09-.73.09-.73 1.2.09 1.83 1.24 1.83 1.24 1.08 1.83 2.81 1.3 3.5 1 .1-.78.42-1.31.76-1.61-2.67-.3-5.47-1.33-5.47-5.93 0-1.31.47-2.38 1.24-3.22-.14-.3-.54-1.52.1-3.18 0 0 1-.32 3.3 1.23a11.5 11.5 0 0 1 6 0c2.28-1.55 3.29-1.23 3.29-1.23.64 1.66.24 2.88.12 3.18a4.65 4.65 0 0 1 1.23 3.22c0 4.61-2.8 5.63-5.48 5.92.42.36.81 1.1.81 2.22l-.01 3.29c0 .31.2.69.82.57A12 12 0 0 0 12 .3Z"/></svg></a> </div> <starlight-theme-select>  <label style="--sl-select-width: 6.25em" class="astro-4yphtoen"> <span class="sr-only astro-4yphtoen">Select theme</span> <svg aria-hidden="true" class="icon label-icon astro-4yphtoen astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21 14h-1V7a3 3 0 0 0-3-3H7a3 3 0 0 0-3 3v7H3a1 1 0 0 0-1 1v2a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-2a1 1 0 0 0-1-1ZM6 7a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v7H6V7Zm14 10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-1h16v1Z"/></svg> <select autocomplete="off" class="astro-4yphtoen"> <option value="dark" class="astro-4yphtoen">Dark</option><option value="light" class="astro-4yphtoen">Light</option><option value="auto" selected class="astro-4yphtoen">Auto</option> </select> <svg aria-hidden="true" class="icon caret astro-4yphtoen astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M17 9.17a1 1 0 0 0-1.41 0L12 12.71 8.46 9.17a1 1 0 1 0-1.41 1.42l4.24 4.24a1.002 1.002 0 0 0 1.42 0L17 10.59a1.002 1.002 0 0 0 0-1.42Z"/></svg> </label>  </starlight-theme-select>  <script>
	StarlightThemeProvider.updatePickers();
</script> <script type="module">const r="starlight-theme",o=e=>e==="auto"||e==="dark"||e==="light"?e:"auto",c=()=>o(typeof localStorage<"u"&&localStorage.getItem(r));function n(e){typeof localStorage<"u"&&localStorage.setItem(r,e==="light"||e==="dark"?e:"")}const l=()=>matchMedia("(prefers-color-scheme: light)").matches?"light":"dark";function t(e){StarlightThemeProvider.updatePickers(e),document.documentElement.dataset.theme=e==="auto"?l():e,n(e)}matchMedia("(prefers-color-scheme: light)").addEventListener("change",()=>{c()==="auto"&&t("auto")});class s extends HTMLElement{constructor(){super(),t(c()),this.querySelector("select")?.addEventListener("change",a=>{a.currentTarget instanceof HTMLSelectElement&&t(o(a.currentTarget.value))})}}customElements.define("starlight-theme-select",s);</script> <script type="module">class s extends HTMLElement{constructor(){super();const e=this.querySelector("select");e&&(e.addEventListener("change",t=>{t.currentTarget instanceof HTMLSelectElement&&(window.location.pathname=t.currentTarget.value)}),window.addEventListener("pageshow",t=>{if(!t.persisted)return;const n=e.querySelector("option[selected]")?.index;n!==e.selectedIndex&&(e.selectedIndex=n??0)}))}}customElements.define("starlight-lang-select",s);</script> </div> </div> </header> <nav class="sidebar print:hidden astro-vrdttmbt" aria-label="Main"> <starlight-menu-button class="print:hidden astro-jif73yzw"> <button aria-expanded="false" aria-label="Menu" aria-controls="starlight__sidebar" class="sl-flex md:sl-hidden astro-jif73yzw"> <svg aria-hidden="true" class="open-menu astro-jif73yzw astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M3 8h18a1 1 0 1 0 0-2H3a1 1 0 0 0 0 2Zm18 8H3a1 1 0 0 0 0 2h18a1 1 0 0 0 0-2Zm0-5H3a1 1 0 0 0 0 2h18a1 1 0 0 0 0-2Z"/></svg> <svg aria-hidden="true" class="close-menu astro-jif73yzw astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="m13.41 12 6.3-6.29a1.004 1.004 0 1 0-1.42-1.42L12 10.59l-6.29-6.3a1.004 1.004 0 0 0-1.42 1.42l6.3 6.29-6.3 6.29a1 1 0 0 0 0 1.42.998.998 0 0 0 1.42 0l6.29-6.3 6.29 6.3a.999.999 0 0 0 1.42 0 1 1 0 0 0 0-1.42L13.41 12Z"/></svg> </button> </starlight-menu-button> <script type="module">class s extends HTMLElement{constructor(){super(),this.btn=this.querySelector("button"),this.btn.addEventListener("click",()=>this.toggleExpanded());const t=this.closest("nav");t&&t.addEventListener("keyup",e=>this.closeOnEscape(e))}setExpanded(t){this.setAttribute("aria-expanded",String(t)),document.body.toggleAttribute("data-mobile-menu-expanded",t)}toggleExpanded(){this.setExpanded(this.getAttribute("aria-expanded")!=="true")}closeOnEscape(t){t.code==="Escape"&&(this.setExpanded(!1),this.btn.focus())}}customElements.define("starlight-menu-button",s);</script>   <div id="starlight__sidebar" class="sidebar-pane astro-vrdttmbt"> <div class="sidebar-content sl-flex astro-vrdttmbt"> <sl-sidebar-state-persist data-hash="1o07nl4" class="astro-kku4brbg"> <script aria-hidden="true">
		(() => {
			try {
				if (!matchMedia('(min-width: 50em)').matches) return;
				/** @type {HTMLElement | null} */
				const target = document.querySelector('sl-sidebar-state-persist');
				const state = JSON.parse(sessionStorage.getItem('sl-sidebar-state') || '0');
				if (!target || !state || target.dataset.hash !== state.hash) return;
				window._starlightScrollRestore = state.scroll;
				customElements.define(
					'sl-sidebar-restore',
					class SidebarRestore extends HTMLElement {
						connectedCallback() {
							try {
								const idx = parseInt(this.dataset.index || '');
								const details = this.closest('details');
								if (details && typeof state.open[idx] === 'boolean') details.open = state.open[idx];
							} catch {}
						}
					}
				);
			} catch {}
		})();
	</script>  <ul class="top-level astro-3ii7xxms"> <li class="astro-3ii7xxms"> <details open class="astro-3ii7xxms"> <summary class="astro-3ii7xxms"> <span class="group-label astro-3ii7xxms"> <span class="large astro-3ii7xxms">Site Info</span>  </span> <svg aria-hidden="true" class="caret astro-3ii7xxms astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg> </summary> <sl-sidebar-restore data-index="0"></sl-sidebar-restore> <ul class="astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/generics/contact/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Contact</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/generics/license/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">License</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/generics/privacypolicy/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Privacy Policy</span>  </a> </li> </ul>  </details> </li><li class="astro-3ii7xxms"> <details open class="astro-3ii7xxms"> <summary class="astro-3ii7xxms"> <span class="group-label astro-3ii7xxms"> <span class="large astro-3ii7xxms">Web Services &amp; HTTPS</span>  </span> <svg aria-hidden="true" class="caret astro-3ii7xxms astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg> </summary> <sl-sidebar-restore data-index="1"></sl-sidebar-restore> <ul class="astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/guides/apache/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Apache Web Server</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/nginx/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Nginx Web Server</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/certbot/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Certbot</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/lamp/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">LAMP Stack</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/lapp/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">LAPP Stack</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/wordpress/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">WordPress</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/adminer/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Adminer Tool</span>  </a> </li> </ul>  </details> </li><li class="astro-3ii7xxms"> <details open class="astro-3ii7xxms"> <summary class="astro-3ii7xxms"> <span class="group-label astro-3ii7xxms"> <span class="large astro-3ii7xxms">Database Management</span>  </span> <svg aria-hidden="true" class="caret astro-3ii7xxms astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg> </summary> <sl-sidebar-restore data-index="2"></sl-sidebar-restore> <ul class="astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/guides/mariadb/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">MariaDB</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/mariadbcluster/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">MariaDB Cluster</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/postgresdebian/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">PostgreSQL (Debian)</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/postgresubuntu/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">PostgreSQL (Ubuntu)</span>  </a> </li> </ul>  </details> </li><li class="astro-3ii7xxms"> <details open class="astro-3ii7xxms"> <summary class="astro-3ii7xxms"> <span class="group-label astro-3ii7xxms"> <span class="large astro-3ii7xxms">Networking</span>  </span> <svg aria-hidden="true" class="caret astro-3ii7xxms astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg> </summary> <sl-sidebar-restore data-index="3"></sl-sidebar-restore> <ul class="astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/guides/networkdebian/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Debian Network Configuration</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/networkubuntu/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Ubuntu Network Configuration</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/ufw/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">UFW (Uncomplicated Firewall)</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/shvpn/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Self-Hosted VPN</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/s2svpn/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Site-to-Site VPN</span>  </a> </li> </ul>  </details> </li><li class="astro-3ii7xxms"> <details open class="astro-3ii7xxms"> <summary class="astro-3ii7xxms"> <span class="group-label astro-3ii7xxms"> <span class="large astro-3ii7xxms">Infrastructure &amp; Virtualization</span>  </span> <svg aria-hidden="true" class="caret astro-3ii7xxms astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg> </summary> <sl-sidebar-restore data-index="4"></sl-sidebar-restore> <ul class="astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/guides/kvm1/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">KVM Virtualization (Beginner)</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/kvm2/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">KVM Virtualization (Networking)</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/keepalived/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Keepalived</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/haproxy/" aria-current="page" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">HAProxy</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/ansible/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Ansible</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/lvm/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">LVM (Logical Volume Management)</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/dns/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">DNS</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/ad/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Active Directory</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/nodejs/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Node.js</span>  </a> </li> </ul>  </details> </li><li class="astro-3ii7xxms"> <details open class="astro-3ii7xxms"> <summary class="astro-3ii7xxms"> <span class="group-label astro-3ii7xxms"> <span class="large astro-3ii7xxms">System Administration Guides</span>  </span> <svg aria-hidden="true" class="caret astro-3ii7xxms astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg> </summary> <sl-sidebar-restore data-index="5"></sl-sidebar-restore> <ul class="astro-3ii7xxms"> <li class="astro-3ii7xxms"> <a href="/guides/useradministration/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">User and Group Administration</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/etcfolder/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">/etc Folder Contents</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/regex/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Regular Expressions</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/filecompression/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">File Compression</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/fhs/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">FHS (Filesystem Hierarchy Standard)</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/systemd/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Systemd Basics</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/systemd2/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Systemd Additional</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/debpackaging/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Debian Packaging</span>  </a> </li><li class="astro-3ii7xxms"> <a href="/guides/otherlinuxes/" aria-current="false" class="astro-3ii7xxms"> <span class="astro-3ii7xxms">Other Linux Distributions</span>  </a> </li> </ul>  </details> </li> </ul>   <script aria-hidden="true">
		(() => {
			const scroller = document.getElementById('starlight__sidebar');
			if (!window._starlightScrollRestore || !scroller) return;
			scroller.scrollTop = window._starlightScrollRestore;
			delete window._starlightScrollRestore;
		})();
	</script> </sl-sidebar-state-persist>  <div class="md:sl-hidden"> <div class="mobile-preferences sl-flex astro-wu23bvmt"> <div class="social-icons astro-wu23bvmt"> <a href="https://github.com/enatsek/" rel="me" class="sl-flex astro-wy4te6ga"><span class="sr-only astro-wy4te6ga">GitHub</span><svg aria-hidden="true" class="astro-wy4te6ga astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M12 .3a12 12 0 0 0-3.8 23.38c.6.12.83-.26.83-.57L9 21.07c-3.34.72-4.04-1.61-4.04-1.61-.55-1.39-1.34-1.76-1.34-1.76-1.08-.74.09-.73.09-.73 1.2.09 1.83 1.24 1.83 1.24 1.08 1.83 2.81 1.3 3.5 1 .1-.78.42-1.31.76-1.61-2.67-.3-5.47-1.33-5.47-5.93 0-1.31.47-2.38 1.24-3.22-.14-.3-.54-1.52.1-3.18 0 0 1-.32 3.3 1.23a11.5 11.5 0 0 1 6 0c2.28-1.55 3.29-1.23 3.29-1.23.64 1.66.24 2.88.12 3.18a4.65 4.65 0 0 1 1.23 3.22c0 4.61-2.8 5.63-5.48 5.92.42.36.81 1.1.81 2.22l-.01 3.29c0 .31.2.69.82.57A12 12 0 0 0 12 .3Z"/></svg></a> </div> <starlight-theme-select>  <label style="--sl-select-width: 6.25em" class="astro-4yphtoen"> <span class="sr-only astro-4yphtoen">Select theme</span> <svg aria-hidden="true" class="icon label-icon astro-4yphtoen astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M21 14h-1V7a3 3 0 0 0-3-3H7a3 3 0 0 0-3 3v7H3a1 1 0 0 0-1 1v2a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-2a1 1 0 0 0-1-1ZM6 7a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v7H6V7Zm14 10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-1h16v1Z"/></svg> <select autocomplete="off" class="astro-4yphtoen"> <option value="dark" class="astro-4yphtoen">Dark</option><option value="light" class="astro-4yphtoen">Light</option><option value="auto" selected class="astro-4yphtoen">Auto</option> </select> <svg aria-hidden="true" class="icon caret astro-4yphtoen astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M17 9.17a1 1 0 0 0-1.41 0L12 12.71 8.46 9.17a1 1 0 1 0-1.41 1.42l4.24 4.24a1.002 1.002 0 0 0 1.42 0L17 10.59a1.002 1.002 0 0 0 0-1.42Z"/></svg> </label>  </starlight-theme-select>  <script>
	StarlightThemeProvider.updatePickers();
</script>   </div>  </div> </div> </div> </nav> <div class="main-frame astro-vrdttmbt">  <script type="module">const a=document.getElementById("starlight__sidebar"),n=a?.querySelector("sl-sidebar-state-persist"),o="sl-sidebar-state",i=()=>{let t=[];const e=n?.dataset.hash||"";try{const s=sessionStorage.getItem(o),r=JSON.parse(s||"{}");Array.isArray(r.open)&&r.hash===e&&(t=r.open)}catch{}return{hash:e,open:t,scroll:a?.scrollTop||0}},c=t=>{try{sessionStorage.setItem(o,JSON.stringify(t))}catch{}},d=()=>c(i()),l=(t,e)=>{const s=i();s.open[e]=t,c(s)};n?.addEventListener("click",t=>{if(!(t.target instanceof Element))return;const e=t.target.closest("summary")?.closest("details");if(!e)return;const s=e.querySelector("sl-sidebar-restore"),r=parseInt(s?.dataset.index||"");isNaN(r)||l(!e.open,r)});addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&d()});addEventListener("pageHide",d);</script> <div class="lg:sl-flex astro-67yu43on"> <aside class="right-sidebar-container print:hidden astro-67yu43on"> <div class="right-sidebar astro-67yu43on"> <div class="lg:sl-hidden astro-pb3aqygn"><mobile-starlight-toc data-min-h="2" data-max-h="3" class="astro-doynk5tl"><nav aria-labelledby="starlight__on-this-page--mobile" class="astro-doynk5tl"><details id="starlight__mobile-toc" class="astro-doynk5tl"><summary id="starlight__on-this-page--mobile" class="sl-flex astro-doynk5tl"><span class="toggle sl-flex astro-doynk5tl">On this page<svg aria-hidden="true" class="caret astro-doynk5tl astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg></span><span class="display-current astro-doynk5tl"></span></summary><div class="dropdown astro-doynk5tl"><ul class="isMobile astro-g2bywc46" style="--depth: 0;"> <li class="astro-g2bywc46" style="--depth: 0;"> <a href="#_top" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">Overview</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#0-specs" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">0. Specs</span> </a> <ul class="isMobile astro-g2bywc46" style="--depth: 1;"> <li class="astro-g2bywc46" style="--depth: 1;"> <a href="#01-the-what" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">0.1. The What</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#02-environment" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">0.2. Environment</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#03-notes" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">0.3. Notes</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#04-sources" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">0.4. Sources</span> </a>  </li> </ul>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#1-install-and-configure-load-balancers" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">1. Install and Configure Load Balancers</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#2-install-and-configure-applicationweb-servers" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">2. Install and Configure Application/Web Servers</span> </a> <ul class="isMobile astro-g2bywc46" style="--depth: 1;"> <li class="astro-g2bywc46" style="--depth: 1;"> <a href="#21-install-and-configure-apache" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">2.1. Install and Configure Apache</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#22-configure-mariadb-on-appweb-servers-srvaw1-srvaw2-and-srvaw3" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">2.2. Configure Mariadb on App/Web Servers (srvaw1, srvaw2, and srvaw3)</span> </a>  </li> </ul>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#3-configure-web-server-load-balancing" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">3. Configure Web Server Load Balancing</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#4-configure-mariadb-load-balancing" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">4. Configure Mariadb Load Balancing</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#5-more-on-haproxy-configuration-options" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">5. More on HAProxy Configuration Options</span> </a> <ul class="isMobile astro-g2bywc46" style="--depth: 1;"> <li class="astro-g2bywc46" style="--depth: 1;"> <a href="#51-default-configuration-file" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">5.1. Default Configuration File</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#52-explanation-of-default-config-parameters" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">5.2. Explanation of Default Config Parameters</span> </a>  </li> </ul>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#6-load-balancing-algorithms" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">6. Load Balancing Algorithms</span> </a> <ul class="isMobile astro-g2bywc46" style="--depth: 1;"> <li class="astro-g2bywc46" style="--depth: 1;"> <a href="#61-round-robin-algorithm" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">6.1. Round Robin Algorithm</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#62-weighted-round-robin-algorithm" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">6.2. Weighted Round Robin Algorithm</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#63-leastconn-algorithm" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">6.3. Leastconn Algorithm</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#64-weighted-leastconn-algorithm" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">6.4. Weighted Leastconn Algorithm</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#65-hash-uri-algorithm" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">6.5. HASH Uri Algorithm</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#66-first-available-algorithm" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">6.6. First Available Algorithm</span> </a>  </li> </ul>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#7-url-redirection" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">7. URL Redirection</span> </a> <ul class="isMobile astro-g2bywc46" style="--depth: 1;"> <li class="astro-g2bywc46" style="--depth: 1;"> <a href="#71-url-path-redirection" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">7.1. URL Path Redirection</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#72-url-parameter-redirection" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">7.2. URL Parameter Redirection</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#73-http-header-redirection" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">7.3. HTTP Header Redirection</span> </a>  </li> </ul>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#8-enabling-https-at-haproxy" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">8. Enabling HTTPS at HAProxy</span> </a> <ul class="isMobile astro-g2bywc46" style="--depth: 1;"> <li class="astro-g2bywc46" style="--depth: 1;"> <a href="#80-configurations--considerations-for-this-section-only" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.0. Configurations &amp; Considerations (For this section only)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#81-initial-installs" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.1. Initial Installs</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#82-install-and-configure-apache-on-the-load-balancer-run-on-www386387xyz" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.2. Install and Configure Apache on the Load Balancer (Run on www.386387.xyz)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#83-configure-haproxy-to-redirect-to-apache-run-on-www386387xyz" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.3. Configure HAProxy to Redirect to Apache (Run on www.386387.xyz)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#84-install-and-run-certbot-run-on-www386387xyz" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.4. Install and Run Certbot (Run on www.386387.xyz)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#85-generate-certificate-for-haproxy-run-on-www386387xyz" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.5. Generate Certificate for HAProxy (Run on www.386387.xyz)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#86-configure-haproxy-run-on-www386387xyz" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.6. Configure HAProxy (Run on www.386387.xyz)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#87-test-certificate-renewal-and-add-renewal-hooks-run-on-www386387xyz" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.7. Test Certificate Renewal and Add Renewal Hooks (Run on www.386387.xyz)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#88-explanations" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.8. Explanations</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#89-enable-https-on-the-web-servers-run-on-srv1386387xyz-and-srv2386387xyz" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.9. Enable HTTPS on the Web Servers (Run on srv1.386387.xyz and srv2.386387.xyz)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#810-configure-haproxy-for-backend-https-tls-re-encryption-run-on-www386387xyz" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.10. Configure HAProxy for Backend HTTPS (TLS Re-Encryption) (Run on www.386387.xyz)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#811-auto-http-to-https-redirection-run-on-www386387xyz" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.11. Auto HTTP to HTTPS Redirection (Run on www.386387.xyz)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#812-server-persistence-sticky-sessions-with-cookies" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.12. Server Persistence (Sticky Sessions) with Cookies</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#813-final-contents-of-haproxy-config-file" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.13. Final Contents of HAProxy Config File</span> </a>  </li> </ul>  </li> </ul> </div></details></nav></mobile-starlight-toc><script type="module" src="/_astro/MobileTableOfContents.astro_astro_type_script_index_0_lang.C181hMzK.js"></script></div><div class="right-sidebar-panel sl-hidden lg:sl-block astro-pb3aqygn"><div class="sl-container astro-pb3aqygn"><starlight-toc data-min-h="2" data-max-h="3"><nav aria-labelledby="starlight__on-this-page"><h2 id="starlight__on-this-page">On this page</h2><ul class="astro-g2bywc46" style="--depth: 0;"> <li class="astro-g2bywc46" style="--depth: 0;"> <a href="#_top" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">Overview</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#0-specs" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">0. Specs</span> </a> <ul class="astro-g2bywc46" style="--depth: 1;"> <li class="astro-g2bywc46" style="--depth: 1;"> <a href="#01-the-what" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">0.1. The What</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#02-environment" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">0.2. Environment</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#03-notes" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">0.3. Notes</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#04-sources" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">0.4. Sources</span> </a>  </li> </ul>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#1-install-and-configure-load-balancers" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">1. Install and Configure Load Balancers</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#2-install-and-configure-applicationweb-servers" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">2. Install and Configure Application/Web Servers</span> </a> <ul class="astro-g2bywc46" style="--depth: 1;"> <li class="astro-g2bywc46" style="--depth: 1;"> <a href="#21-install-and-configure-apache" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">2.1. Install and Configure Apache</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#22-configure-mariadb-on-appweb-servers-srvaw1-srvaw2-and-srvaw3" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">2.2. Configure Mariadb on App/Web Servers (srvaw1, srvaw2, and srvaw3)</span> </a>  </li> </ul>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#3-configure-web-server-load-balancing" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">3. Configure Web Server Load Balancing</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#4-configure-mariadb-load-balancing" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">4. Configure Mariadb Load Balancing</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#5-more-on-haproxy-configuration-options" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">5. More on HAProxy Configuration Options</span> </a> <ul class="astro-g2bywc46" style="--depth: 1;"> <li class="astro-g2bywc46" style="--depth: 1;"> <a href="#51-default-configuration-file" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">5.1. Default Configuration File</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#52-explanation-of-default-config-parameters" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">5.2. Explanation of Default Config Parameters</span> </a>  </li> </ul>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#6-load-balancing-algorithms" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">6. Load Balancing Algorithms</span> </a> <ul class="astro-g2bywc46" style="--depth: 1;"> <li class="astro-g2bywc46" style="--depth: 1;"> <a href="#61-round-robin-algorithm" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">6.1. Round Robin Algorithm</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#62-weighted-round-robin-algorithm" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">6.2. Weighted Round Robin Algorithm</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#63-leastconn-algorithm" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">6.3. Leastconn Algorithm</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#64-weighted-leastconn-algorithm" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">6.4. Weighted Leastconn Algorithm</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#65-hash-uri-algorithm" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">6.5. HASH Uri Algorithm</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#66-first-available-algorithm" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">6.6. First Available Algorithm</span> </a>  </li> </ul>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#7-url-redirection" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">7. URL Redirection</span> </a> <ul class="astro-g2bywc46" style="--depth: 1;"> <li class="astro-g2bywc46" style="--depth: 1;"> <a href="#71-url-path-redirection" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">7.1. URL Path Redirection</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#72-url-parameter-redirection" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">7.2. URL Parameter Redirection</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#73-http-header-redirection" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">7.3. HTTP Header Redirection</span> </a>  </li> </ul>  </li><li class="astro-g2bywc46" style="--depth: 0;"> <a href="#8-enabling-https-at-haproxy" class="astro-g2bywc46" style="--depth: 0;"> <span class="astro-g2bywc46" style="--depth: 0;">8. Enabling HTTPS at HAProxy</span> </a> <ul class="astro-g2bywc46" style="--depth: 1;"> <li class="astro-g2bywc46" style="--depth: 1;"> <a href="#80-configurations--considerations-for-this-section-only" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.0. Configurations &amp; Considerations (For this section only)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#81-initial-installs" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.1. Initial Installs</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#82-install-and-configure-apache-on-the-load-balancer-run-on-www386387xyz" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.2. Install and Configure Apache on the Load Balancer (Run on www.386387.xyz)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#83-configure-haproxy-to-redirect-to-apache-run-on-www386387xyz" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.3. Configure HAProxy to Redirect to Apache (Run on www.386387.xyz)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#84-install-and-run-certbot-run-on-www386387xyz" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.4. Install and Run Certbot (Run on www.386387.xyz)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#85-generate-certificate-for-haproxy-run-on-www386387xyz" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.5. Generate Certificate for HAProxy (Run on www.386387.xyz)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#86-configure-haproxy-run-on-www386387xyz" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.6. Configure HAProxy (Run on www.386387.xyz)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#87-test-certificate-renewal-and-add-renewal-hooks-run-on-www386387xyz" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.7. Test Certificate Renewal and Add Renewal Hooks (Run on www.386387.xyz)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#88-explanations" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.8. Explanations</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#89-enable-https-on-the-web-servers-run-on-srv1386387xyz-and-srv2386387xyz" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.9. Enable HTTPS on the Web Servers (Run on srv1.386387.xyz and srv2.386387.xyz)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#810-configure-haproxy-for-backend-https-tls-re-encryption-run-on-www386387xyz" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.10. Configure HAProxy for Backend HTTPS (TLS Re-Encryption) (Run on www.386387.xyz)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#811-auto-http-to-https-redirection-run-on-www386387xyz" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.11. Auto HTTP to HTTPS Redirection (Run on www.386387.xyz)</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#812-server-persistence-sticky-sessions-with-cookies" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.12. Server Persistence (Sticky Sessions) with Cookies</span> </a>  </li><li class="astro-g2bywc46" style="--depth: 1;"> <a href="#813-final-contents-of-haproxy-config-file" class="astro-g2bywc46" style="--depth: 1;"> <span class="astro-g2bywc46" style="--depth: 1;">8.13. Final Contents of HAProxy Config File</span> </a>  </li> </ul>  </li> </ul> </nav></starlight-toc><script type="module" src="/_astro/TableOfContents.astro_astro_type_script_index_0_lang.CKWWgpjV.js"></script></div></div> </div> </aside> <div class="main-pane astro-67yu43on">  <main data-pagefind-body class="astro-bguv2lll" lang="en" dir="ltr">    <div class="content-panel astro-7nkwcw3z"> <div class="sl-container astro-7nkwcw3z"> <h1 id="_top" class="astro-j6tvhyss">HAProxy</h1>  </div> </div>  <div class="content-panel astro-7nkwcw3z"> <div class="sl-container astro-7nkwcw3z"> <div class="sl-markdown-content"> <div class="sl-heading-wrapper level-h5"><h5 id="high-availability-load-balancing-with-ssltls-and-keepalived">High-availability load balancing with SSL/TLS and keepalived</h5><a class="sl-anchor-link" href="#high-availability-load-balancing-with-ssltls-and-keepalived"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “High-availability load balancing with SSL/TLS and keepalived”</span></a></div>
<div class="sl-heading-wrapper level-h2"><h2 id="0-specs">0. Specs</h2><a class="sl-anchor-link" href="#0-specs"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “0. Specs”</span></a></div>
<hr>
<div class="sl-heading-wrapper level-h3"><h3 id="01-the-what">0.1. The What</h3><a class="sl-anchor-link" href="#01-the-what"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “0.1. The What”</span></a></div>
<p>HAProxy is a free, open-source software that acts as a high-availability load balancer and proxy for TCP and HTTP-based applications. It efficiently distributes requests across multiple servers and is widely used by high-traffic websites. HAProxy offers features like SSL termination, caching, and health checking.</p>
<p>This tutorial demonstrates how to set up High Availability Load Balancing with free Let’s Encrypt certificates for HTTPS support.</p>
<div class="sl-heading-wrapper level-h3"><h3 id="02-environment">0.2. Environment</h3><a class="sl-anchor-link" href="#02-environment"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “0.2. Environment”</span></a></div>
<ul>
<li>srv    : Load Balancer floating (virtual) IP —> 192.168.1.200</li>
<li>srvlb1 : Load Balancer 1  —> 192.168.1.201</li>
<li>srvlb2 : Load Balancer 2  —> 192.168.1.202</li>
<li>srvaw1 : App/Web Server 1 —> 192.168.1.203</li>
<li>srvaw2 : App/Web Server 2 —> 192.168.1.204</li>
<li>srvaw3 : App/Web Server 3 —> 192.168.1.205</li>
</ul>
<p>Tested on Debian 13/12 and Ubuntu 24.04/22.04 LTS Servers.</p>
<div class="sl-heading-wrapper level-h3"><h3 id="03-notes">0.3. Notes</h3><a class="sl-anchor-link" href="#03-notes"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “0.3. Notes”</span></a></div>
<p>We will use a Keepalived cluster of two load balancers. Under normal conditions, the first server will handle the traffic. However, if the first load balancer fails or is powered off, the second will take over. This step is not strictly necessary but eliminates the risk of a Single Point of Failure.</p>
<p>This setup ensures our infrastructure remains operational even if one of the servers goes offline.</p>
<p>The two Load Balancers will be configured with the floating IP <code dir="auto">192.168.1.200</code>.<br>
Our Application or Web Servers must be configured identically so that users will never know which server they are connected to.</p>
<p>For this example, we will install Apache and MariaDB on each App/Web server.</p>
<p>We will also install a Galera cluster to establish MariaDB clustering. This ensures that any database change on one server is replicated to the others.</p>
<p>First, we will load balance the web server, then we will load balance the MariaDB database usage. This will demonstrate that you can load balance virtually any kind of software.</p>
<p>Users will only see the floating IP (<code dir="auto">192.168.1.200</code>) of the Load Balancers and will not be aware of the other servers or their IPs.</p>
<div class="sl-heading-wrapper level-h3"><h3 id="04-sources">0.4. Sources</h3><a class="sl-anchor-link" href="#04-sources"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “0.4. Sources”</span></a></div>
<ul>
<li><a href="https://www.haproxy.org/">www.haproxy.org</a></li>
<li><a href="https://www.server-world.info/en/note?os=Ubuntu_20.04&#x26;p=haproxy&#x26;f=1">www.server-world.info</a></li>
<li><a href="https://docs.haproxy.org/">HAProxy Documentation</a></li>
<li>Book: ISBN: 9781519073846 <strong>Load Balancing with HAProxy</strong> by Nick Ramirez</li>
</ul>
<br>
<div class="sl-heading-wrapper level-h2"><h2 id="1-install-and-configure-load-balancers">1. Install and Configure Load Balancers</h2><a class="sl-anchor-link" href="#1-install-and-configure-load-balancers"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “1. Install and Configure Load Balancers”</span></a></div>
<hr>
<p><strong>Install Keepalived (on srvlb1 and srvlb2)</strong></p>
<div class="expressive-code"><link rel="stylesheet" href="/_astro/ec.v4551.css"><script type="module" src="/_astro/ec.0vx5m.js"></script><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo apt update</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo apt install keepalived --yes</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo apt updatesudo apt install keepalived --yes"><div></div></button></div></figure></div>
<p><strong>Configure Keepalived on the First Load Balancer (srvlb1)</strong></p>
<p>Create a configuration file:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo nano /etc/keepalived/keepalived.conf</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo nano /etc/keepalived/keepalived.conf"><div></div></button></div></figure></div>
<p>Fill it with the following content. Remember to replace <code dir="auto">enp0s3</code> with your actual network adapter name.</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">global_defs {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">router_id node1</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">vrrp_instance VI_1 {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">    </span></span><span style="--0:#d6deeb;--1:#403f53">state MASTER</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">interface enp0s3</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">virtual_router_id 51</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">priority 100</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">advert_int 5</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">virtual_ipaddress {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">192.168.1.200</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">}</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="global_defs {  router_id node1}vrrp_instance VI_1 {    state MASTER  interface enp0s3  virtual_router_id 51  priority 100  advert_int 5  virtual_ipaddress {  192.168.1.200  }}"><div></div></button></div></figure></div>
<p><strong>Configure Keepalived on the Second Load Balancer (srvlb2)</strong></p>
<p>Create a configuration file:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo nano /etc/keepalived/keepalived.conf</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo nano /etc/keepalived/keepalived.conf"><div></div></button></div></figure></div>
<p>Fill it with the following content. Again, remember to replace <code dir="auto">enp0s3</code> with your network adapter name.</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">global_defs {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">router_id node2</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">vrrp_instance VI_1 {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">    </span></span><span style="--0:#d6deeb;--1:#403f53">state BACKUP</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">interface enp0s3</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">virtual_router_id 51</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">priority 90</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">advert_int 5</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">virtual_ipaddress {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">192.168.1.200</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">}</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="global_defs {  router_id node2}vrrp_instance VI_1 {    state BACKUP  interface enp0s3  virtual_router_id 51  priority 90  advert_int 5  virtual_ipaddress {  192.168.1.200  }}"><div></div></button></div></figure></div>
<p><strong>Start Keepalived on Both Load Balancers (srvlb1 and srvlb2)</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo systemctl start keepalived</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo systemctl start keepalived"><div></div></button></div></figure></div>
<p>You can check the status of Keepalived with:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo systemctl status -l keepalived</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo systemctl status -l keepalived"><div></div></button></div></figure></div>
<p><strong>Install HAProxy on Both Load Balancers (srvlb1 and srvlb2)</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo apt install haproxy --yes</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo apt install haproxy --yes"><div></div></button></div></figure></div>
<p>Stop the service for now; we will restart it after configuration:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo systemctl stop haproxy</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo systemctl stop haproxy"><div></div></button></div></figure></div>
<br>
<div class="sl-heading-wrapper level-h2"><h2 id="2-install-and-configure-applicationweb-servers">2. Install and Configure Application/Web Servers</h2><a class="sl-anchor-link" href="#2-install-and-configure-applicationweb-servers"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “2. Install and Configure Application/Web Servers”</span></a></div>
<hr>
<div class="sl-heading-wrapper level-h3"><h3 id="21-install-and-configure-apache">2.1. Install and Configure Apache</h3><a class="sl-anchor-link" href="#21-install-and-configure-apache"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “2.1. Install and Configure Apache”</span></a></div>
<p>Install Apache, MariaDB, and Galera Cluster on all App/Web servers (srvaw1, srvaw2, and srvaw3):</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo apt update</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo apt install apache2 mariadb-server galera-4 --yes</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo apt updatesudo apt install apache2 mariadb-server galera-4 --yes"><div></div></button></div></figure></div>
<p>Create a default web page for each server. For testing purposes, we’ll include the server name to identify which server is responding. In a production environment, these files would be identical.</p>
<p>Delete the original file and create a new one on each server (srvaw1, srvaw2, and srvaw3):</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo rm /var/www/html/index.html</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo nano /var/www/html/index.html</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo rm /var/www/html/index.htmlsudo nano /var/www/html/index.html"><div></div></button></div></figure></div>
<p><strong>For srvaw1:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;html></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;title>SrvAW1&#x3C;/title></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;body></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;h1>SrvAW1&#x3C;/h1></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;p>Empty yet.&#x3C;/p></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;/body></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;/html></span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="<html><title>SrvAW1</title><body><h1>SrvAW1</h1><p>Empty yet.</p></body></html>"><div></div></button></div></figure></div>
<p><strong>For srvaw2:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;html></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;title>SrvAW2&#x3C;/title></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;body></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;h1>SrvAW2&#x3C;/h1></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;p>Empty yet.&#x3C;/p></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;/body></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;/html></span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="<html><title>SrvAW2</title><body><h1>SrvAW2</h1><p>Empty yet.</p></body></html>"><div></div></button></div></figure></div>
<p><strong>For srvaw3:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;html></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;title>SrvAW3&#x3C;/title></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;body></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;h1>SrvAW3&#x3C;/h1></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;p>Empty yet.&#x3C;/p></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;/body></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;/html></span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="<html><title>SrvAW3</title><body><h1>SrvAW3</h1><p>Empty yet.</p></body></html>"><div></div></button></div></figure></div>
<p><strong>Apache Configuration for Logs</strong></p>
<p><strong>Apache Configuration for Logs</strong></p>
<p>Since web access is forwarded through the load balancer, the App/Web servers will see the Load Balancer’s IP as the client IP. As a result, all access and error logs will show the LB’s IP instead of the real client IP. To log the correct client IPs, some configuration is required.</p>
<p>Enable the Apache2 <code dir="auto">remoteip</code> module on all App/Web servers (srvaw1, srvaw2, and srvaw3):</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo a2enmod remoteip</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo a2enmod remoteip"><div></div></button></div></figure></div>
<p>Configure Apache to use the <code dir="auto">X-Forwarded-For</code> header (added by the load balancer) in its logs.</p>
<p>Edit the Apache configuration file on all app/web servers (srvaw1, srvaw2, and srvaw3):</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo nano /etc/apache2/apache2.conf</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo nano /etc/apache2/apache2.conf"><div></div></button></div></figure></div>
<p>Around line 212, add the first two lines and modify the next two lines as shown below. Remember to use your LB IPs.</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">RemoteIPHeader X-Forwarded-For</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">RemoteIPInternalProxy 192.168.1.201 192.168.1.202</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">LogFormat "%v:%p %a %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" vhost_combined</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">LogFormat "%a %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" combined</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="RemoteIPHeader X-Forwarded-ForRemoteIPInternalProxy 192.168.1.201 192.168.1.202LogFormat &#x22;%v:%p %a %l %u %t \&#x22;%r\&#x22; %>s %O \&#x22;%{Referer}i\&#x22; \&#x22;%{User-Agent}i\&#x22;&#x22; vhost_combinedLogFormat &#x22;%a %l %u %t \&#x22;%r\&#x22; %>s %O \&#x22;%{Referer}i\&#x22; \&#x22;%{User-Agent}i\&#x22;&#x22; combined"><div></div></button></div></figure></div>
<p>Restart Apache on all app/web servers (srvaw1, srvaw2, and srvaw3):</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo systemctl restart apache2</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo systemctl restart apache2"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="22-configure-mariadb-on-appweb-servers-srvaw1-srvaw2-and-srvaw3">2.2. Configure Mariadb on App/Web Servers (srvaw1, srvaw2, and srvaw3)</h3><a class="sl-anchor-link" href="#22-configure-mariadb-on-appweb-servers-srvaw1-srvaw2-and-srvaw3"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “2.2. Configure Mariadb on App/Web Servers (srvaw1, srvaw2, and srvaw3)”</span></a></div>
<p><strong>Secure Mariadb Installations</strong></p>
<p>Run the security script to apply basic security settings to MariaDB (srvaw1, srvaw2, and srvaw3):</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo mariadb-secure-installation</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo mariadb-secure-installation"><div></div></button></div></figure></div>
<p>You will be asked a series of questions. Here are recommended answers:</p>
<ul>
<li>
<p><code dir="auto">Enter current password for root (enter for none):</code><br>
Press <strong>Enter</strong> as there is no password set yet.</p>
</li>
<li>
<p><code dir="auto">Switch to unix_socket authentication [Y/n]</code><br>
The root account is already protected on Debian/Ubuntu. You can answer <strong><code dir="auto">n</code></strong>.</p>
</li>
<li>
<p><code dir="auto">Change the root password? [Y/n]</code><br>
For the same reason, you can answer <strong><code dir="auto">n</code></strong>.</p>
</li>
<li>
<p>For the remaining questions (remove anonymous users, disallow root login remotely, remove test database, reload privilege tables), it is safe to accept the defaults by pressing <strong><code dir="auto">Y</code></strong>.</p>
</li>
</ul>
<p><strong>Create a MariaDB User for Remote Access</strong></p>
<p>Create a user for testing from your workstation. Remember to use your LB IPs and a secure password. Run this on all App/Web servers (srvaw1, srvaw2, and srvaw3):</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo mariadb</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo mariadb"><div></div></button></div></figure></div>
<p>In the MariaDB shell, execute:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">GRANT ALL ON *.* TO 'admin'@'192.168.1.201' IDENTIFIED BY 'Password12';</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">GRANT ALL ON *.* TO 'admin'@'192.168.1.202' IDENTIFIED BY 'Password12';</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">FLUSH PRIVILEGES;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">EXIT;</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="GRANT ALL ON *.* TO &#x27;admin&#x27;@&#x27;192.168.1.201&#x27; IDENTIFIED BY &#x27;Password12&#x27;;GRANT ALL ON *.* TO &#x27;admin&#x27;@&#x27;192.168.1.202&#x27; IDENTIFIED BY &#x27;Password12&#x27;;FLUSH PRIVILEGES;EXIT;"><div></div></button></div></figure></div>
<p><strong>Configure Galera cluster</strong>*</p>
<p>Temporarily stop MariaDB on all app/web servers before configuration (srvaw1, srvaw2, and srvaw3):</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo systemctl stop mariadb</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo systemctl stop mariadb"><div></div></button></div></figure></div>
<p>Configure MariaDB to listen on all interfaces. This is necessary for the cluster and will also allow connections from your workstation.</p>
<p>Edit the configuration file on all app/web servers (srvaw1, srvaw2, and srvaw3):</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo nano /etc/mysql/mariadb.conf.d/50-server.cnf</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo nano /etc/mysql/mariadb.conf.d/50-server.cnf"><div></div></button></div></figure></div>
<p>Find the following line (around lines 27-30):</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">bind-address = 127.0.0.1</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="bind-address = 127.0.0.1"><div></div></button></div></figure></div>
<p>Change it to:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">bind-address = 0.0.0.0</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="bind-address = 0.0.0.0"><div></div></button></div></figure></div>
<p>Create a new configuration file for the cluster on all app/web servers (srvaw1, srvaw2, and srvaw3):</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo nano /etc/mysql/mariadb.conf.d/99-cluster.cnf</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo nano /etc/mysql/mariadb.conf.d/99-cluster.cnf"><div></div></button></div></figure></div>
<p>Fill it with the following content, replacing the IP addresses with your own:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">[galera]</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">innodb_autoinc_lock_mode = 2</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">wsrep_cluster_name    = "x386_cluster"</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">wsrep_cluster_address = "gcomm://192.168.1.203,192.168.1.204,192.168.1.205"</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">wsrep_provider = /usr/lib/galera/libgalera_smm.so</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">wsrep_provider_options = "evs.suspect_timeout=PT10S"</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">wsrep_on = on</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">default_storage_engine = InnoDB</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">innodb_doublewrite = 1</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">binlog_format = ROW</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="[galera]innodb_autoinc_lock_mode = 2wsrep_cluster_name    = &#x22;x386_cluster&#x22;wsrep_cluster_address = &#x22;gcomm://192.168.1.203,192.168.1.204,192.168.1.205&#x22;wsrep_provider = /usr/lib/galera/libgalera_smm.sowsrep_provider_options = &#x22;evs.suspect_timeout=PT10S&#x22;wsrep_on = ondefault_storage_engine = InnoDBinnodb_doublewrite = 1binlog_format = ROW"><div></div></button></div></figure></div>
<p><strong>Start the Galera Cluster</strong></p>
<p>Initialize the cluster on the first App/Web server (srvaw1):</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo galera_new_cluster</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo galera_new_cluster"><div></div></button></div></figure></div>
<p>This command will start MariaDB on this node.</p>
<p>Now start MariaDB on the other nodes (srvaw2 and srvaw3):</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo systemctl start mariadb</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo systemctl start mariadb"><div></div></button></div></figure></div>
<br>
<div class="sl-heading-wrapper level-h2"><h2 id="3-configure-web-server-load-balancing">3. Configure Web Server Load Balancing</h2><a class="sl-anchor-link" href="#3-configure-web-server-load-balancing"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “3. Configure Web Server Load Balancing”</span></a></div>
<hr>
<p>We will configure HAProxy to load balance the three web servers (192.168.1.203, 192.168.1.204, and 192.168.1.205).</p>
<p><strong>Configure HAProxy on both Load Balancers (srvlb1 and srvlb2):</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo nano /etc/haproxy/haproxy.cfg</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo nano /etc/haproxy/haproxy.cfg"><div></div></button></div></figure></div>
<p>Add the following configuration to the end of the file:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53"># define frontend for apache</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">frontend fe_http_80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53"># listen to port 80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">bind *:80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53"># set the backend</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">default_backend    be_http_80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53"># send X-Forwarded-For header</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">option   forwardfor</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53"># define backend for apache</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">backend be_http_80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53"># use roundrobin algorithm for balancing</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">balance  roundrobin</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53"># define backend servers</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srvaw1 192.168.1.203:80 check</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srvaw2 192.168.1.204:80 check</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srvaw3 192.168.1.205:80 check</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="# define frontend for apachefrontend fe_http_80        # listen to port 80        bind *:80        # set the backend        default_backend    be_http_80        # send X-Forwarded-For header        option   forwardfor# define backend for apachebackend be_http_80        # use roundrobin algorithm for balancing        balance  roundrobin        # define backend servers        server   srvaw1 192.168.1.203:80 check        server   srvaw2 192.168.1.204:80 check        server   srvaw3 192.168.1.205:80 check"><div></div></button></div></figure></div>
<p><strong>Restart HAProxy on both Load Balancers (srvlb1 and srvlb2):</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo systemctl restart haproxy</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo systemctl restart haproxy"><div></div></button></div></figure></div>
<p><strong>Explanations</strong></p>
<ul>
<li><strong>Frontend:</strong> Handles incoming connections to the Load Balancer (LB).</li>
<li><strong>Backend:</strong> Defines the pool of servers to which connections are forwarded.</li>
</ul>
<p>Let’s break down the configuration:</p>
<ul>
<li>
<p><code dir="auto">frontend fe_http_80</code>
Defines a frontend and labels it <code dir="auto">fe_http_80</code>. You can use any descriptive name.</p>
</li>
<li>
<p><code dir="auto">bind *:80</code>
Instructs HAProxy to listen for incoming connections on all IP addresses of the LB on port 80.</p>
</li>
<li>
<p><code dir="auto">default_backend be_http_80</code>
Specifies that incoming traffic for this frontend should be sent to the backend named <code dir="auto">be_http_80</code>.</p>
</li>
<li>
<p><code dir="auto">option forwardfor</code>
Captures the client’s IP address and adds it to an <code dir="auto">X-Forwarded-For</code> HTTP header. This allows Apache to log the real client IP instead of the LB’s IP.</p>
</li>
<li>
<p><code dir="auto">backend be_http_80</code>
Defines the backend named <code dir="auto">be_http_80</code>.</p>
</li>
<li>
<p><code dir="auto">balance roundrobin</code>
Uses the Round Robin algorithm for load balancing. This means requests are distributed to the backend servers one after the other in a circular order. Other algorithms will be explained in Section 5.</p>
</li>
<li>
<p><code dir="auto">server srvaw1 192.168.1.203:80 check</code>
<code dir="auto">server srvaw2 192.168.1.204:80 check</code>
<code dir="auto">server srvaw3 192.168.1.205:80 check</code>
These lines list the backend servers. <code dir="auto">srvaw1</code>, <code dir="auto">srvaw2</code>, and <code dir="auto">srvaw3</code> are labels. The IP and port specify where to forward the traffic. The <code dir="auto">check</code> parameter instructs the LB to perform health checks on the backend server to see if it is alive. Other parameters will be explained in Section 5.</p>
</li>
</ul>
<p><strong>Testing</strong></p>
<p>You can now connect to the website at <code dir="auto">http://192.168.1.200</code> from different workstations. You should see that connections are being distributed across <code dir="auto">192.168.1.203</code>, <code dir="auto">192.168.1.204</code>, and <code dir="auto">192.168.1.205</code>.</p>
<br>
<div class="sl-heading-wrapper level-h2"><h2 id="4-configure-mariadb-load-balancing">4. Configure Mariadb Load Balancing</h2><a class="sl-anchor-link" href="#4-configure-mariadb-load-balancing"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “4. Configure Mariadb Load Balancing”</span></a></div>
<hr>
<p><strong>Notes:</strong></p>
<p>Load Balancing an application is similar to load balancing a web server.</p>
<p>The key is to identify the TCP/IP port the application uses and configure HAProxy accordingly. For MariaDB, which uses port 3306, we will use the <code dir="auto">mode tcp</code> directive in both the frontend and backend sections. This instructs HAProxy to perform Layer 4 (TCP) load balancing instead of Layer 7 (HTTP).</p>
<p><strong>Configure HAProxy on both Load Balancers (srvlb1 and srvlb2):</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo nano /etc/haproxy/haproxy.cfg</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo nano /etc/haproxy/haproxy.cfg"><div></div></button></div></figure></div>
<p>Add the following configuration to the end of the file:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53"># define frontend for mariadb</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">frontend fe_mariadb_3306</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">mode            tcp</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53"># listen to port 3306</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">bind *:3306</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53"># set the backend</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">default_backend    be_mariadb_3306</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53"># define backend for mariadb</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">backend be_mariadb_3306</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">mode            tcp</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53"># use roundrobin algorithm for balancing</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">balance  roundrobin</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53"># define backend servers</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srvaw1 192.168.1.203:3306 check</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srvaw2 192.168.1.204:3306 check</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srvaw3 192.168.1.205:3306 check</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="# define frontend for mariadbfrontend fe_mariadb_3306        mode            tcp        # listen to port 3306        bind *:3306        # set the backend        default_backend    be_mariadb_3306# define backend for mariadbbackend be_mariadb_3306        mode            tcp        # use roundrobin algorithm for balancing        balance  roundrobin        # define backend servers        server   srvaw1 192.168.1.203:3306 check        server   srvaw2 192.168.1.204:3306 check        server   srvaw3 192.168.1.205:3306 check"><div></div></button></div></figure></div>
<p>We can reload the configuration to apply these changes without interrupting the existing web server load balancing:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo systemctl reload haproxy</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo systemctl reload haproxy"><div></div></button></div></figure></div>
<p><strong>Testing</strong></p>
<p>You can connect from your workstation using the following command.</p>
<p><strong>Remember:</strong> You need to have the <code dir="auto">mariadb-client</code> package installed on your workstation.</p>
<p>Use the password you set in section 2.2.</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">mariadb -u admin -p -h 192.168.1.200</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="mariadb -u admin -p -h 192.168.1.200"><div></div></button></div></figure></div>
<p>Once connected to the MariaDB shell, you can run the following command to identify which server you are connected to:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">SHOW VARIABLES LIKE 'hostname';</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="SHOW VARIABLES LIKE &#x27;hostname&#x27;;"><div></div></button></div></figure></div>
<br>
<div class="sl-heading-wrapper level-h2"><h2 id="5-more-on-haproxy-configuration-options">5. More on HAProxy Configuration Options</h2><a class="sl-anchor-link" href="#5-more-on-haproxy-configuration-options"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “5. More on HAProxy Configuration Options”</span></a></div>
<hr>
<div class="sl-heading-wrapper level-h3"><h3 id="51-default-configuration-file">5.1. Default Configuration File</h3><a class="sl-anchor-link" href="#51-default-configuration-file"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “5.1. Default Configuration File”</span></a></div>
<p>The default configuration file is <code dir="auto">/etc/haproxy/haproxy.cfg</code>. Its initial contents are similar to the following:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">global</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">log /dev/log    local0</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">log /dev/log    local1 notice</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">chroot /var/lib/haproxy</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">stats timeout 30s</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">user haproxy</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">group haproxy</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">daemon</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53"># Default SSL material locations</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">ca-base /etc/ssl/certs</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">crt-base /etc/ssl/private</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53"># See: https://ssl-config.mozilla.org/#server=haproxy&#x26;serve...</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDH...</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AE...</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">defaults</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">log     global</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">mode    http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">option  httplog</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">option  dontlognull</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">timeout connect 5000</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">timeout client  50000</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">timeout server  50000</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">errorfile 400 /etc/haproxy/errors/400.http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">errorfile 403 /etc/haproxy/errors/403.http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">errorfile 408 /etc/haproxy/errors/408.http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">errorfile 500 /etc/haproxy/errors/500.http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">errorfile 502 /etc/haproxy/errors/502.http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">errorfile 503 /etc/haproxy/errors/503.http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">errorfile 504 /etc/haproxy/errors/504.http</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="global        log /dev/log    local0        log /dev/log    local1 notice        chroot /var/lib/haproxy        stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners        stats timeout 30s        user haproxy        group haproxy        daemon        # Default SSL material locations        ca-base /etc/ssl/certs        crt-base /etc/ssl/private        # See: https://ssl-config.mozilla.org/#server=haproxy&#x26;serve...        ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDH...        ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AE...        ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-ticketsdefaults        log     global        mode    http        option  httplog        option  dontlognull        timeout connect 5000        timeout client  50000        timeout server  50000        errorfile 400 /etc/haproxy/errors/400.http        errorfile 403 /etc/haproxy/errors/403.http        errorfile 408 /etc/haproxy/errors/408.http        errorfile 500 /etc/haproxy/errors/500.http        errorfile 502 /etc/haproxy/errors/502.http        errorfile 503 /etc/haproxy/errors/503.http        errorfile 504 /etc/haproxy/errors/504.http"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="52-explanation-of-default-config-parameters">5.2. Explanation of Default Config Parameters</h3><a class="sl-anchor-link" href="#52-explanation-of-default-config-parameters"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “5.2. Explanation of Default Config Parameters”</span></a></div>
<p><strong><code dir="auto">global</code> Section</strong></p>
<ul>
<li><strong><code dir="auto">log</code></strong>: Configures logging for requests and errors. These settings usually do not need to be changed.</li>
<li><strong><code dir="auto">chroot</code></strong>: Enhances security by running HAProxy in a isolated directory, preventing access to other parts of the filesystem.</li>
<li><strong><code dir="auto">stats</code></strong>: Enables the HAProxy statistics socket for command-line access and sets its timeout value.</li>
<li><strong><code dir="auto">user</code></strong> and <strong><code dir="auto">group</code></strong>: Define the system user and group under which the HAProxy process runs.</li>
<li><strong><code dir="auto">daemon</code></strong>: Runs HAProxy as a background daemon.</li>
<li><strong><code dir="auto">ca-base</code></strong> and <strong><code dir="auto">crt-base</code></strong>: Define the default directories for TLS (SSL) certificates, which are used when load balancing HTTPS sites.</li>
<li>The three <strong><code dir="auto">ssl-default-...</code></strong> options specify the default ciphers and protocols for SSL/TLS configuration.</li>
</ul>
<p>Many more parameters are available. For a full reference, see: <a href="https://cbonte.github.io/haproxy-dconv/2.3/configuration.html#3">cbonte.github.io/haproxy-dconv</a></p>
<p><strong><code dir="auto">defaults</code> Section</strong></p>
<ul>
<li><strong><code dir="auto">log global</code></strong>: Specifies that subsequent definitions will use the logging options set in the <code dir="auto">global</code> section.</li>
<li><strong><code dir="auto">mode http</code></strong>: Sets the default load balancing mode to Layer 7 (HTTP). We overrode this with <code dir="auto">mode tcp</code> for MariaDB to use Layer 4 (TCP) load balancing.</li>
<li><strong><code dir="auto">option httplog</code></strong>: Enables verbose logging for HTTP requests.</li>
<li><strong><code dir="auto">option dontlognull</code></strong>: Ignores and does not log connections that send no data.</li>
<li><strong>Timeout directives</strong> (values in milliseconds):
<ul>
<li><strong><code dir="auto">timeout connect</code></strong>: Maximum time to wait for a connection to a backend server to be established.</li>
<li><strong><code dir="auto">timeout client</code></strong>: Maximum time to wait for client data.</li>
<li><strong><code dir="auto">timeout server</code></strong>: Maximum time to wait for a response from a backend server.</li>
</ul>
</li>
<li><strong><code dir="auto">errorfile</code></strong>: Defines the HTML files to be served when HAProxy encounters specific errors. These files can be customized.</li>
</ul>
<p><strong><code dir="auto">frontend</code> Section</strong></p>
<p>This section defines the part of the Load Balancer that users connect to. Here, you define the listening IPs and ports and reference the backend section where requests should be forwarded.</p>
<p><strong><code dir="auto">backend</code> Section</strong></p>
<p>This section defines the pool of servers (IPs and ports) to which requests are forwarded. You can also define the load balancing algorithm, mode, and other server-specific parameters here.</p>
<p><strong><code dir="auto">listen</code> Section</strong></p>
<p>This is a third type of section that combines the <code dir="auto">frontend</code> and <code dir="auto">backend</code> definitions into a single block. It is useful for simpler configurations. Here is a basic example:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">listen myproxy</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">     </span></span><span style="--0:#d6deeb;--1:#403f53">bind *:80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">     </span></span><span style="--0:#d6deeb;--1:#403f53">server srv1 192.168.1.181:80</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="listen myproxy     bind *:80     server srv1 192.168.1.181:80"><div></div></button></div></figure></div>
<br>
<div class="sl-heading-wrapper level-h2"><h2 id="6-load-balancing-algorithms">6. Load Balancing Algorithms</h2><a class="sl-anchor-link" href="#6-load-balancing-algorithms"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “6. Load Balancing Algorithms”</span></a></div>
<hr>
<p>HAProxy supports several load balancing algorithms. Here are the most common ones:</p>
<ul>
<li><strong>Round Robin:</strong> Distributes traffic equally among servers in sequence.</li>
<li><strong>Weighted Round Robin:</strong> Distributes traffic based on assigned server weights.</li>
<li><strong>Leastconn:</strong> Sends new connections to the server with the least number of current connections.</li>
<li><strong>Weighted Leastconn:</strong> Sends new connections to the server with the lowest (connections/weight) ratio.</li>
<li><strong>Hash (URI):</strong> Uses a hash of the request (e.g., the URI) to always send the same type of request to the same server.</li>
<li><strong>First Available:</strong> Each server accepts a defined number of connections sequentially.</li>
</ul>
<div class="sl-heading-wrapper level-h3"><h3 id="61-round-robin-algorithm">6.1. Round Robin Algorithm</h3><a class="sl-anchor-link" href="#61-round-robin-algorithm"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “6.1. Round Robin Algorithm”</span></a></div>
<p>We used this algorithm for our Apache and MariaDB load balancers. It is a simple method to distribute traffic equally by forwarding requests to each server in turn.</p>
<p><strong>Example frontend and backend configuration:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">frontend fe_http_80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">bind *:80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">default_backend    be_http_80</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">backend be_http_80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">balance  roundrobin</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv1 192.168.1.203:80 check</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv2 192.168.1.204:80 check</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv3 192.168.1.205:80 check</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="frontend fe_http_80        bind *:80        default_backend    be_http_80backend be_http_80        balance  roundrobin        server   srv1 192.168.1.203:80 check        server   srv2 192.168.1.204:80 check        server   srv3 192.168.1.205:80 check"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="62-weighted-round-robin-algorithm">6.2. Weighted Round Robin Algorithm</h3><a class="sl-anchor-link" href="#62-weighted-round-robin-algorithm"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “6.2. Weighted Round Robin Algorithm”</span></a></div>
<p>Weighted Round Robin is similar to the standard Round Robin but allows you to assign weights to backend servers. This is useful when some servers have more processing power and should handle a larger share of the traffic.</p>
<p><strong>Example configuration where <code dir="auto">srv1</code> and <code dir="auto">srv2</code> handle twice as much traffic as <code dir="auto">srv3</code>:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">frontend fe_http_80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">bind *:80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">default_backend    be_http_80</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">backend be_http_80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">balance  roundrobin</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv1 192.168.1.202:80 weight 2 check</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv2 192.168.1.203:80 weight 2 check</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv3 192.168.1.204:80 weight 1 check</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="frontend fe_http_80        bind *:80        default_backend    be_http_80backend be_http_80        balance  roundrobin        server   srv1 192.168.1.202:80 weight 2 check        server   srv2 192.168.1.203:80 weight 2 check        server   srv3 192.168.1.204:80 weight 1 check"><div></div></button></div></figure></div>
<p>You can temporarily disable a backend server using the <code dir="auto">disabled</code> keyword:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv3 192.168.1.204:80 weight 1 disabled</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="        server   srv3 192.168.1.204:80 weight 1 disabled"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="63-leastconn-algorithm">6.3. Leastconn Algorithm</h3><a class="sl-anchor-link" href="#63-leastconn-algorithm"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “6.3. Leastconn Algorithm”</span></a></div>
<p>The Leastconn algorithm distribributes traffic to the server with the fewest active connections. This is particularly useful for load balancing long-lived connections, such as with databases.</p>
<p><strong>Example frontend and backend configuration:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">frontend fe_mariadb_3306</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">mode            tcp</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">bind *:3306</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">default_backend    be_mariadb_3306</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">backend be_mariadb_3306</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">mode            tcp</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">balance  leastconn</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv1 192.168.1.203:3306 check</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv2 192.168.1.204:3306 check</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv3 192.168.1.205:3306 check</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="frontend fe_mariadb_3306        mode            tcp        bind *:3306        default_backend    be_mariadb_3306backend be_mariadb_3306        mode            tcp        balance  leastconn        server   srv1 192.168.1.203:3306 check        server   srv2 192.168.1.204:3306 check        server   srv3 192.168.1.205:3306 check"><div></div></button></div></figure></div>
<p>With this algorithm, a newly added server might immediately receive all new traffic because it has zero connections. To avoid this, use the <code dir="auto">slowstart</code> parameter followed by a time period:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv4 192.168.1.232:3306 check slowstart 60s</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="        server   srv4 192.168.1.232:3306 check slowstart 60s"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="64-weighted-leastconn-algorithm">6.4. Weighted Leastconn Algorithm</h3><a class="sl-anchor-link" href="#64-weighted-leastconn-algorithm"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “6.4. Weighted Leastconn Algorithm”</span></a></div>
<p>Weighted Leastconn is similar to the standard Leastconn algorithm but incorporates server weights. Servers with a higher weight will be able to handle more connections relative to their capacity.</p>
<p><strong>Example configuration where <code dir="auto">srv1</code> and <code dir="auto">srv2</code> can handle twice as many connections as <code dir="auto">srv3</code>:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">frontend fe_mariadb_3306</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">mode            tcp</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">bind *:3306</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">default_backend    be_mariadb_3306</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">backend be_mariadb_3306</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">mode            tcp</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">balance  leastconn</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv1 192.168.1.203:3306 weight 2 check</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv2 192.168.1.204:3306 weight 2 check</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv3 192.168.1.205:3306 weight 1 check</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="frontend fe_mariadb_3306        mode            tcp        bind *:3306        default_backend    be_mariadb_3306backend be_mariadb_3306        mode            tcp        balance  leastconn        server   srv1 192.168.1.203:3306 weight 2 check        server   srv2 192.168.1.204:3306 weight 2 check        server   srv3 192.168.1.205:3306 weight 1 check"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="65-hash-uri-algorithm">6.5. HASH Uri Algorithm</h3><a class="sl-anchor-link" href="#65-hash-uri-algorithm"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “6.5. HASH Uri Algorithm”</span></a></div>
<p>This algorithm is highly useful for load balancing static web servers with caching. It hashes the request URI (or part of it) to ensure the same request is always forwarded to the same backend server, thereby increasing cache hits and performance.</p>
<p><strong>Example frontend and backend configuration:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">frontend fe_http_80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">bind *:80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">default_backend    be_http_80</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">backend be_http_80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">balance  uri</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv1 192.168.1.203:80 check</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv2 192.168.1.204:80 check</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv3 192.168.1.205:80 check</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="frontend fe_http_80        bind *:80        default_backend    be_http_80backend be_http_80        balance  uri        server   srv1 192.168.1.203:80 check        server   srv2 192.168.1.204:80 check        server   srv3 192.168.1.205:80 check"><div></div></button></div></figure></div>
<p>This algorithm can also be used in weighted mode to better utilize faster servers.</p>
<p><strong>Example with weights, where <code dir="auto">srv1</code> and <code dir="auto">srv2</code> handle more traffic:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">frontend fe_http_80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">bind *:80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">default_backend    be_http_80</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">backend be_http_80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">balance  uri</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv1 192.168.1.202:80 weight 2 check</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv2 192.168.1.203:80 weight 2 check</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv3 192.168.1.204:80 weight 1 check</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="frontend fe_http_80        bind *:80        default_backend    be_http_80backend be_http_80        balance  uri        server   srv1 192.168.1.202:80 weight 2 check        server   srv2 192.168.1.203:80 weight 2 check        server   srv3 192.168.1.204:80 weight 1 check"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="66-first-available-algorithm">6.6. First Available Algorithm</h3><a class="sl-anchor-link" href="#66-first-available-algorithm"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “6.6. First Available Algorithm”</span></a></div>
<p>This algorithm uses servers sequentially. It directs connections to the first server until it reaches a specified maximum connection count, then moves to the next server. This can be useful for cost-saving when you don’t want to spin up additional servers unless necessary.</p>
<p><strong>Example configuration where each server handles up to 50 connections:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">frontend fe_http_80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">bind *:80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">default_backend    be_http_80</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">backend be_http_80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">balance  first</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv1 192.168.1.203:80 maxconn 50</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv2 192.168.1.204:80 maxconn 50</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv3 192.168.1.205:80 maxconn 50</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="frontend fe_http_80        bind *:80        default_backend    be_http_80backend be_http_80        balance  first        server   srv1 192.168.1.203:80 maxconn 50        server   srv2 192.168.1.204:80 maxconn 50        server   srv3 192.168.1.205:80 maxconn 50"><div></div></button></div></figure></div>
<br>
<div class="sl-heading-wrapper level-h2"><h2 id="7-url-redirection">7. URL Redirection</h2><a class="sl-anchor-link" href="#7-url-redirection"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “7. URL Redirection”</span></a></div>
<hr>
<p>HAProxy can redirect requests based on the URL path, URL parameters, HTTP headers, or the HTTP host address. This functionality can significantly optimize traffic handling in various scenarios.</p>
<div class="sl-heading-wrapper level-h3"><h3 id="71-url-path-redirection">7.1. URL Path Redirection</h3><a class="sl-anchor-link" href="#71-url-path-redirection"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “7.1. URL Path Redirection”</span></a></div>
<p><strong>Scenario</strong></p>
<p>Assume we have three folders on our web servers: <code dir="auto">folder1</code>, <code dir="auto">folder2</code>, and <code dir="auto">folder3</code>. We want to redirect requests for <code dir="auto">folder1</code> to <code dir="auto">srvaw1</code>, <code dir="auto">folder2</code> to <code dir="auto">srvaw2</code>, and <code dir="auto">folder3</code> to <code dir="auto">srvaw3</code>. All other traffic should be load-balanced as defined in Section 3.</p>
<p><strong>Configuration</strong></p>
<p>Edit the HAProxy configuration file on the load balancers:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo nano /etc/haproxy/haproxy.cfg</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo nano /etc/haproxy/haproxy.cfg"><div></div></button></div></figure></div>
<p>Remove the previously added backend and frontend sections for HTTP and add the following to the end of the file:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">frontend fe_http_80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">bind *:80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">acl acl_folder1 path_beg -i /folder1</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">use_backend be_folder1 if acl_folder1</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">acl acl_folder2 path_beg -i /folder2</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">use_backend be_folder2 if acl_folder2</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">acl acl_folder3 path_beg -i /folder3</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">use_backend be_folder3 if acl_folder3</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">default_backend    be_http_80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">option   forwardfor</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">backend be_folder1</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srvaw1 192.168.1.203:80 check</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">backend be_folder2</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srvaw2 192.168.1.204:80 check</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">backend be_folder3</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srvaw3 192.168.1.205:80 check</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">backend be_http_80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">balance  roundrobin</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srvaw1 192.168.1.203:80 check</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srvaw2 192.168.1.204:80 check</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srvaw3 192.168.1.205:80 check</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="frontend fe_http_80  bind *:80  acl acl_folder1 path_beg -i /folder1  use_backend be_folder1 if acl_folder1  acl acl_folder2 path_beg -i /folder2  use_backend be_folder2 if acl_folder2  acl acl_folder3 path_beg -i /folder3  use_backend be_folder3 if acl_folder3  default_backend    be_http_80        option   forwardforbackend be_folder1        server   srvaw1 192.168.1.203:80 checkbackend be_folder2        server   srvaw2 192.168.1.204:80 checkbackend be_folder3        server   srvaw3 192.168.1.205:80 checkbackend be_http_80        balance  roundrobin        server   srvaw1 192.168.1.203:80 check        server   srvaw2 192.168.1.204:80 check        server   srvaw3 192.168.1.205:80 check"><div></div></button></div></figure></div>
<p><strong>Restart or Reload HAProxy</strong></p>
<p>To apply the changes, you can restart HAProxy:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo systemctl restart haproxy</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo systemctl restart haproxy"><div></div></button></div></figure></div>
<p>If HAProxy is already active and you want to avoid dropping connections, reload it instead:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo systemctl reload haproxy</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo systemctl reload haproxy"><div></div></button></div></figure></div>
<p><strong>Explanations</strong></p>
<p>ACLs (Access Control Lists) are used to define conditions for matching requests.</p>
<ul>
<li><code dir="auto">acl acl_folder1 path_beg -i /folder1</code>
<ul>
<li><code dir="auto">acl</code> is the keyword to define an ACL.</li>
<li><code dir="auto">acl_folder1</code> is the name given to this ACL.</li>
<li><code dir="auto">path_beg</code> is the condition, meaning the URL path begins with the following string.</li>
<li><code dir="auto">-i</code> makes the string match case-insensitive.</li>
<li><code dir="auto">/folder1</code> is the string we are looking for.</li>
</ul>
</li>
</ul>
<p>The ACL <code dir="auto">acl_folder1</code> is activated when a URL path starts with <code dir="auto">/folder1</code>, for example:<br>
<code dir="auto">http://www.386387.xyz/folder1</code></p>
<p>For a URL like <code dir="auto">http://www.386387.xyz/folder1/folder2/folder3</code>, the URL Path is <code dir="auto">/folder1/folder2/folder3</code>.</p>
<ul>
<li><code dir="auto">use_backend be_folder1 if acl_folder1</code>
This directive instructs HAProxy to use the servers in the <code dir="auto">be_folder1</code> backend when <code dir="auto">acl_folder1</code> is activated.</li>
</ul>
<p>Similar ACLs and backends are created for <code dir="auto">/folder2</code> and <code dir="auto">/folder3</code>.</p>
<p>There are other conditions for matching URL paths. Here is a list:</p>
<ul>
<li><code dir="auto">path</code>: Exact URL path match.</li>
<li><code dir="auto">path_beg</code>: URL path begins with the string.</li>
<li><code dir="auto">path_end</code>: URL path ends with the string.</li>
<li><code dir="auto">path_sub</code>: URL path contains the string as a substring.</li>
<li><code dir="auto">path_dir</code>: URL path has the string as a subdirectory.</li>
<li><code dir="auto">path_len</code>: Exact length of the URL path.</li>
<li><code dir="auto">path_reg</code>: Regex match of the URL path.</li>
</ul>
<p><strong>URL Path ACL Examples</strong></p>
<p>An ACL for an exact info page:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">acl acl_info path -i /info/info.html</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="acl acl_info path -i /info/info.html"><div></div></button></div></figure></div>
<p>An ACL for JPG and PNG images:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">acl acl_image path_end .jpg .png</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="acl acl_image path_end .jpg .png"><div></div></button></div></figure></div>
<p>An ACL for image directories:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">acl acl_image2 path_dir -i /images</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="acl acl_image2 path_dir -i /images"><div></div></button></div></figure></div>
<p>An ACL for URL paths longer than 20 characters:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">acl acl_long path_len gt 20</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="acl acl_long path_len gt 20"><div></div></button></div></figure></div>
<p>An ACL for paths containing “cart”:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">acl acl_cart path_sub -i cart</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="acl acl_cart path_sub -i cart"><div></div></button></div></figure></div>
<p>An ACL for images using a regular expression:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">acl acl_image3 path_reg (jpg|jpeg|bmp|gif|png)</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="acl acl_image3 path_reg (jpg|jpeg|bmp|gif|png)"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="72-url-parameter-redirection">7.2. URL Parameter Redirection</h3><a class="sl-anchor-link" href="#72-url-parameter-redirection"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “7.2. URL Parameter Redirection”</span></a></div>
<p>A URL parameter is a key-value pair (e.g., <code dir="auto">variable=value</code>). Many websites, like Google and DuckDuckGo, use them. For example:<br>
<code dir="auto">https://www.example.org/?s=searchterm</code></p>
<p>Here, <code dir="auto">s</code> is the variable (for “search”) and <code dir="auto">searchterm</code> is the value. HAProxy can capture these parameters and redirect specific key-value pairs to different backends.</p>
<p><strong>Example</strong></p>
<p>Assume we have a parameter named <code dir="auto">block_number</code> with possible values: <code dir="auto">first</code>, <code dir="auto">second</code>, <code dir="auto">third</code>, and <code dir="auto">rest</code>. A URL for the first block would look like:<br>
<code dir="auto">http://www.386387.xyz/?block_number=first</code></p>
<p>We want to redirect:</p>
<ul>
<li><code dir="auto">first</code> to one backend.</li>
<li><code dir="auto">second</code> and <code dir="auto">third</code> to another backend.</li>
<li><code dir="auto">rest</code> to a third backend.</li>
</ul>
<p>A sample frontend configuration would be:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">frontend fe_blocks</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">bind *:80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">acl acl_block1 url_param(block_number) -i -m str first</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">use_backend be_block1 if acl_block1</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">acl acl_block23 url_param(block_number) -i -m str second third</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">use_backend be_block23 if acl_block23</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">acl acl_blockrest url_param(block_number) -i -m str rest</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">use_backend be_blockrest if acl_blockrest</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">default_backend blocks</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="frontend fe_blocks  bind *:80  acl acl_block1 url_param(block_number) -i -m str first  use_backend be_block1 if acl_block1  acl acl_block23 url_param(block_number) -i -m str second third  use_backend be_block23 if acl_block23  acl acl_blockrest url_param(block_number) -i -m str rest  use_backend be_blockrest if acl_blockrest  default_backend blocks"><div></div></button></div></figure></div>
<p>The <code dir="auto">-i</code> directive enables case-insensitive matching. The <code dir="auto">-m str</code> directive enables exact string matching for the values provided.</p>
<div class="sl-heading-wrapper level-h3"><h3 id="73-http-header-redirection">7.3. HTTP Header Redirection</h3><a class="sl-anchor-link" href="#73-http-header-redirection"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “7.3. HTTP Header Redirection”</span></a></div>
<p>HTTP headers contain information such as <code dir="auto">User-Agent</code>, <code dir="auto">Host</code> (the website address), <code dir="auto">Content-Type</code>, and <code dir="auto">Referer</code>. For a full list, please refer to:<br>
<a href="https://en.wikipedia.org/wiki/List_of_HTTP_header_fields">https://en.wikipedia.org/wiki/List_of_HTTP_header_fields</a></p>
<p>A <code dir="auto">User-Agent</code> header might look like this:<br>
<code dir="auto">Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:87.0) Gecko/20100101 Firefox/87.0</code></p>
<p>A <code dir="auto">Host</code> header might look like this:<br>
<code dir="auto">Host: www.386387.xyz</code></p>
<p><strong>Example: Redirecting Mobile Traffic</strong></p>
<p>The following frontend configuration redirects requests from mobile devices to a specific backend based on the <code dir="auto">User-Agent</code> header.</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">frontend be_http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">bind *:80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">acl acl_mobile req.hdr(User-Agent) -i -m reg (android|iphone)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">use_backend be_mobile if acl_mobile</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">default_backend be_http</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="frontend be_http  bind *:80  acl acl_mobile req.hdr(User-Agent) -i -m reg (android|iphone)  use_backend be_mobile if acl_mobile  default_backend be_http"><div></div></button></div></figure></div>
<br>
<div class="sl-heading-wrapper level-h2"><h2 id="8-enabling-https-at-haproxy">8. Enabling HTTPS at HAProxy</h2><a class="sl-anchor-link" href="#8-enabling-https-at-haproxy"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “8. Enabling HTTPS at HAProxy”</span></a></div>
<hr>
<p>This section covers enabling HTTPS in HAProxy using free TLS (SSL) certificates from Let’s Encrypt, managed by the Certbot tool for automatic renewals every 90 days.</p>
<p>All steps described here have been tested. Since Let’s Encrypt requires internet-accessible servers for domain validation, this section uses VPS servers. For simplicity, we’ll use a single HAProxy server and two web servers (without Keepalived).</p>
<div class="sl-heading-wrapper level-h3"><h3 id="80-configurations--considerations-for-this-section-only">8.0. Configurations &#x26; Considerations (For this section only)</h3><a class="sl-anchor-link" href="#80-configurations--considerations-for-this-section-only"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “8.0. Configurations &#x26; Considerations (For this section only)”</span></a></div>
<p><strong>Server Setup:</strong></p>
<ul>
<li><code dir="auto">www.386387.xyz</code>: Load Balancer → <code dir="auto">159.203.70.143</code></li>
<li><code dir="auto">srv1.386387.xyz</code>: Web Server 1 → <code dir="auto">64.225.29.174</code></li>
<li><code dir="auto">srv2.386387.xyz</code>: Web Server 2 → <code dir="auto">165.227.176.14</code></li>
</ul>
<p>Tested on Debian 13/12 and Ubuntu 24.04/22.04 LTS Servers.</p>
<p>We start with freshly installed servers.</p>
<p><strong>Challenge:</strong> To obtain and renew Let’s Encrypt certificates with Certbot, a web server must be accessible on port 80. However, HAProxy also needs to bind to port 80. This creates a conflict.</p>
<p><strong>Solution:</strong> We install Apache on the Load Balancer but bind it only to the loopback interface (<code dir="auto">127.0.0.1</code>). HAProxy will bind to the server’s public IPs. We then configure HAProxy to redirect Let’s Encrypt validation requests (to the <code dir="auto">/.well-known/acme-challenge</code> directory) to the local Apache instance. This allows both Apache and HAProxy to coexist on port 80.</p>
<div class="sl-heading-wrapper level-h3"><h3 id="81-initial-installs">8.1. Initial Installs</h3><a class="sl-anchor-link" href="#81-initial-installs"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “8.1. Initial Installs”</span></a></div>
<p><strong>Install HAProxy on the Load Balancer (<code dir="auto">www.386387.xyz</code>):</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo apt update</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo apt install haproxy --yes</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo systemctl stop haproxy</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo apt updatesudo apt install haproxy --yessudo systemctl stop haproxy"><div></div></button></div></figure></div>
<p><strong>Install Apache on the Web Servers (<code dir="auto">srv1.386387.xyz</code> and <code dir="auto">srv2.386387.xyz</code>):</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo apt update</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo apt install apache2 --yes</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo apt updatesudo apt install apache2 --yes"><div></div></button></div></figure></div>
<p><strong>Create a test page on each web server:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo rm /var/www/html/index.html</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo nano /var/www/html/index.html</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo rm /var/www/html/index.htmlsudo nano /var/www/html/index.html"><div></div></button></div></figure></div>
<p><strong>For <code dir="auto">srv1.386387.xyz</code>:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;html></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;title>SrvAW1&#x3C;/title></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;body></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;h1>Srv1&#x3C;/h1></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;p>Empty yet.&#x3C;/p></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;/body></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;/html></span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="<html><title>SrvAW1</title><body><h1>Srv1</h1><p>Empty yet.</p></body></html>"><div></div></button></div></figure></div>
<p><strong>For <code dir="auto">srv2.386387.xyz</code>:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;html></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;title>SrvAW1&#x3C;/title></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;body></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;h1>Srv2&#x3C;/h1></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;p>Empty yet.&#x3C;/p></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;/body></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;/html></span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="<html><title>SrvAW1</title><body><h1>Srv2</h1><p>Empty yet.</p></body></html>"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="82-install-and-configure-apache-on-the-load-balancer-run-on-www386387xyz">8.2. Install and Configure Apache on the Load Balancer (Run on <code dir="auto">www.386387.xyz</code>)</h3><a class="sl-anchor-link" href="#82-install-and-configure-apache-on-the-load-balancer-run-on-www386387xyz"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “8.2. Install and Configure Apache on the Load Balancer (Run on www.386387.xyz)”</span></a></div>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo apt update</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo apt install apache2 --yes</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo apt updatesudo apt install apache2 --yes"><div></div></button></div></figure></div>
<p>Apache might fail to start due to port 80 being occupied by HAProxy. This is expected and will be resolved.</p>
<p><strong>Configure Apache to bind only to the loopback interface:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo nano /etc/apache2/ports.conf</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo nano /etc/apache2/ports.conf"><div></div></button></div></figure></div>
<p>Modify the file to look like this:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">Listen 127.0.0.1:80</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;IfModule ssl_module></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">Listen 127.0.0.1:443</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;/IfModule></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;IfModule mod_gnutls.c></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">Listen 127.0.0.1:443</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;/IfModule></span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="Listen 127.0.0.1:80<IfModule ssl_module>        Listen 127.0.0.1:443</IfModule><IfModule mod_gnutls.c>        Listen 127.0.0.1:443</IfModule>"><div></div></button></div></figure></div>
<p><strong>Configure the default virtual host:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo nano /etc/apache2/sites-available/000-default.conf</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo nano /etc/apache2/sites-available/000-default.conf"><div></div></button></div></figure></div>
<p>Update the file with your domain(s):</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;VirtualHost 127.0.0.1:80></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">ServerAdmin webmaster@localhost</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">ServerName www.386387.xyz</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">ServerAlias 386387.xyz</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">DocumentRoot /var/www/html</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">ErrorLog ${APACHE_LOG_DIR}/error.log</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">CustomLog ${APACHE_LOG_DIR}/access.log combined</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;/VirtualHost></span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="<VirtualHost 127.0.0.1:80>        ServerAdmin webmaster@localhost        ServerName www.386387.xyz        ServerAlias 386387.xyz        DocumentRoot /var/www/html        ErrorLog ${APACHE_LOG_DIR}/error.log        CustomLog ${APACHE_LOG_DIR}/access.log combined</VirtualHost>"><div></div></button></div></figure></div>
<p><strong>Create the Let’s Encrypt challenge directory:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo mkdir -p /var/www/html/.well-known/acme-challenge</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo mkdir -p /var/www/html/.well-known/acme-challenge"><div></div></button></div></figure></div>
<p><strong>Restart Apache:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo systemctl restart apache2</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo systemctl restart apache2"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="83-configure-haproxy-to-redirect-to-apache-run-on-www386387xyz">8.3. Configure HAProxy to Redirect to Apache (Run on <code dir="auto">www.386387.xyz</code>)</h3><a class="sl-anchor-link" href="#83-configure-haproxy-to-redirect-to-apache-run-on-www386387xyz"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “8.3. Configure HAProxy to Redirect to Apache (Run on www.386387.xyz)”</span></a></div>
<p>Edit the HAProxy configuration file</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo nano /etc/haproxy/haproxy.cfg</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo nano /etc/haproxy/haproxy.cfg"><div></div></button></div></figure></div>
<p>Add the following to the end of the file. Replace the IP address in the <code dir="auto">bind</code> directive with your Load Balancer’s public IP (find it using <code dir="auto">ip a</code>).</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">frontend fe_http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">bind 159.203.70.143:80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">acl acl_acme path_beg -i /.well-known/acme-challenge</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">use_backend be_acme if acl_acme</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">backend be_acme</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server self 127.0.0.1:80 check</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="frontend fe_http        bind 159.203.70.143:80        acl acl_acme path_beg -i /.well-known/acme-challenge        use_backend be_acme if acl_acmebackend be_acme        server self 127.0.0.1:80 check"><div></div></button></div></figure></div>
<p><strong>Restart HAProxy:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo systemctl restart haproxy</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo systemctl restart haproxy"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="84-install-and-run-certbot-run-on-www386387xyz">8.4. Install and Run Certbot (Run on <code dir="auto">www.386387.xyz</code>)</h3><a class="sl-anchor-link" href="#84-install-and-run-certbot-run-on-www386387xyz"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “8.4. Install and Run Certbot (Run on www.386387.xyz)”</span></a></div>
<p><strong>Install Certbot:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo apt update</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo apt install --yes  certbot</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo apt updatesudo apt install --yes  certbot"><div></div></button></div></figure></div>
<p><strong>Generate certificates using the webroot plugin. Replace the domains with your own:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo certbot certonly --webroot --webroot-path /var/www/html \</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">   </span></span><span style="--0:#d6deeb;--1:#403f53">-d www.386387.xyz,386387.xyz</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo certbot certonly --webroot --webroot-path /var/www/html \   -d www.386387.xyz,386387.xyz"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="85-generate-certificate-for-haproxy-run-on-www386387xyz">8.5. Generate Certificate for HAProxy (Run on <a href="http://www.386387.xyz">www.386387.xyz</a>)</h3><a class="sl-anchor-link" href="#85-generate-certificate-for-haproxy-run-on-www386387xyz"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “8.5. Generate Certificate for HAProxy (Run on www.386387.xyz)”</span></a></div>
<p>Let’s Encrypt certificates are stored in <code dir="auto">/etc/letsencrypt/live/</code>. Your directory will be named after your primary domain.</p>
<p><strong>Find your certificate directory:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo ls -al /etc/letsencrypt/live</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo ls -al /etc/letsencrypt/live"><div></div></button></div></figure></div>
<p>HAProxy requires the certificate and private key to be in a single file. Replace <code dir="auto">www.386387.xyz</code> with your actual domain name from the command above.</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo -i</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">cd /etc/letsencrypt/live/www.386387.xyz</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">cat fullchain.pem privkey.pem >> haproxy.pem</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">exit</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo -icd /etc/letsencrypt/live/www.386387.xyzcat fullchain.pem privkey.pem >> haproxy.pemexit"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="86-configure-haproxy-run-on-www386387xyz">8.6. Configure HAProxy (Run on <a href="http://www.386387.xyz">www.386387.xyz</a>)</h3><a class="sl-anchor-link" href="#86-configure-haproxy-run-on-www386387xyz"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “8.6. Configure HAProxy (Run on www.386387.xyz)”</span></a></div>
<p>We will now update the HAProxy configuration to handle HTTPS traffic and load balance the backend servers.</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo nano /etc/haproxy/haproxy.cfg</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo nano /etc/haproxy/haproxy.cfg"><div></div></button></div></figure></div>
<p>Replace the configuration at the end of the file with the following:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">frontend fe_http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">bind 159.203.70.143:80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">bind 159.203.70.143:443 ssl crt /etc/letsencrypt/live/www.386387.xyz/haproxy.pem</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">acl acl_acme path_beg -i /.well-known/acme-challenge</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">use_backend be_acme if acl_acme</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">default_backend    be_http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">option   forwardfor</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">backend be_acme</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server self 127.0.0.1:80 check</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">backend be_http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">balance  roundrobin</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv1 64.225.29.174:80 check</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv2 165.227.176.14:80 check</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="frontend fe_http        bind 159.203.70.143:80        bind 159.203.70.143:443 ssl crt /etc/letsencrypt/live/www.386387.xyz/haproxy.pem        acl acl_acme path_beg -i /.well-known/acme-challenge        use_backend be_acme if acl_acme        default_backend    be_http        option   forwardforbackend be_acme        server self 127.0.0.1:80 checkbackend be_http        balance  roundrobin        server   srv1 64.225.29.174:80 check        server   srv2 165.227.176.14:80 check"><div></div></button></div></figure></div>
<p><strong>Restart HAProxy:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo systemctl restart haproxy</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo systemctl restart haproxy"><div></div></button></div></figure></div>
<p>HTTPS is now active, but we will add further refinements.</p>
<div class="sl-heading-wrapper level-h3"><h3 id="87-test-certificate-renewal-and-add-renewal-hooks-run-on-www386387xyz">8.7. Test Certificate Renewal and Add Renewal Hooks (Run on <code dir="auto">www.386387.xyz</code>)</h3><a class="sl-anchor-link" href="#87-test-certificate-renewal-and-add-renewal-hooks-run-on-www386387xyz"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “8.7. Test Certificate Renewal and Add Renewal Hooks (Run on www.386387.xyz)”</span></a></div>
<p>Let’s Encrypt certificates are valid for 90 days. Certbot can automatically renew them. Test the renewal process with a dry run:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo certbot renew --dry-run</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo certbot renew --dry-run"><div></div></button></div></figure></div>
<p>If this runs without errors, automatic renewal should work.</p>
<p>However, every time the certificate is renewed, we must regenerate the combined <code dir="auto">haproxy.pem</code> file and reload HAProxy. We can automate this by placing a script in the Certbot renewal hooks directory.</p>
<p>Certbot executes scripts in <code dir="auto">/etc/letsencrypt/renewal-hooks/deploy/</code> after a successful renewal.</p>
<p><strong>Create the hook script:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo nano /etc/letsencrypt/renewal-hooks/deploy/haproxy.sh</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo nano /etc/letsencrypt/renewal-hooks/deploy/haproxy.sh"><div></div></button></div></figure></div>
<p>Add the following content, replacing the domain name with yours:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">cat /etc/letsencrypt/live/www.386387.xyz/fullchain.pem /etc/letsencrypt/live/www.386387.xyz/privkey.pem \</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">  </span></span><span style="--0:#d6deeb;--1:#403f53">>> /etc/letsencrypt/live/www.386387.xyz/haproxy.pem</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">systemctl restart haproxy</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="cat /etc/letsencrypt/live/www.386387.xyz/fullchain.pem /etc/letsencrypt/live/www.386387.xyz/privkey.pem \  >> /etc/letsencrypt/live/www.386387.xyz/haproxy.pemsystemctl restart haproxy"><div></div></button></div></figure></div>
<p><strong>Make the script executable:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo chmod +x /etc/letsencrypt/renewal-hooks/deploy/haproxy.sh</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo chmod +x /etc/letsencrypt/renewal-hooks/deploy/haproxy.sh"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="88-explanations">8.8. Explanations</h3><a class="sl-anchor-link" href="#88-explanations"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “8.8. Explanations”</span></a></div>
<p>At this stage, we have a fully functional HTTPS setup with automatic certificate renewal. Note that only the traffic between the client and the Load Balancer is encrypted (TLS Termination). The traffic between the Load Balancer and the web servers is still in plain HTTP.</p>
<p>For enhanced security, especially if your web servers are internet-accessible, we can encrypt this backend traffic as well using TLS Re-Encryption. We will achieve this by using self-signed certificates on the web servers and configuring HAProxy to connect to them via HTTPS.</p>
<div class="sl-heading-wrapper level-h3"><h3 id="89-enable-https-on-the-web-servers-run-on-srv1386387xyz-and-srv2386387xyz">8.9. Enable HTTPS on the Web Servers (Run on <code dir="auto">srv1.386387.xyz</code> and <code dir="auto">srv2.386387.xyz</code>)</h3><a class="sl-anchor-link" href="#89-enable-https-on-the-web-servers-run-on-srv1386387xyz-and-srv2386387xyz"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “8.9. Enable HTTPS on the Web Servers (Run on srv1.386387.xyz and srv2.386387.xyz)”</span></a></div>
<p><strong>Enable the Apache SSL module:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo a2enmod ssl</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo systemctl restart apache2</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo a2enmod sslsudo systemctl restart apache2"><div></div></button></div></figure></div>
<p><strong>Create a directory for certificates:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo mkdir /etc/apache2/certs</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo mkdir /etc/apache2/certs"><div></div></button></div></figure></div>
<p><strong>Generate a self-signed certificate (valid for ~20 years):</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo openssl req -x509 -nodes -days 7300 -newkey rsa:2048 \</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">-keyout /etc/apache2/certs/www.386387.xyz.key -out /etc/apache2/certs/www.386387.xyz.crt</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo openssl req -x509 -nodes -days 7300 -newkey rsa:2048 \-keyout /etc/apache2/certs/www.386387.xyz.key -out /etc/apache2/certs/www.386387.xyz.crt"><div></div></button></div></figure></div>
<p>Fill in the prompts appropriately when asked.</p>
<p><strong>Create a new virtual host configuration for SSL:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo nano /etc/apache2/sites-available/000-virtual-ssl.conf</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo nano /etc/apache2/sites-available/000-virtual-ssl.conf"><div></div></button></div></figure></div>
<p>Add the following configuration:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;IfModule mod_ssl.c></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">    </span></span><span style="--0:#d6deeb;--1:#403f53">&#x3C;VirtualHost *:443></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">ServerName www.386387.xyz</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">ServerAlias 386387.xyz</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">ServerAdmin webmaster@www.386387.xyz</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">DocumentRoot /var/www/html</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">ErrorLog ${APACHE_LOG_DIR}/www.386387.xyz-error.log</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">CustomLog ${APACHE_LOG_DIR}/www.386387.xyz-access.log combined</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">SSLEngine on</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">SSLCertificateFile  /etc/apache2/certs/www.386387.xyz.crt</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">SSLCertificateKeyFile  /etc/apache2/certs/www.386387.xyz.key</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">    </span></span><span style="--0:#d6deeb;--1:#403f53">&#x3C;/VirtualHost></span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">&#x3C;/IfModule></span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="<IfModule mod_ssl.c>    <VirtualHost *:443>        ServerName www.386387.xyz        ServerAlias 386387.xyz        ServerAdmin webmaster@www.386387.xyz        DocumentRoot /var/www/html        ErrorLog ${APACHE_LOG_DIR}/www.386387.xyz-error.log        CustomLog ${APACHE_LOG_DIR}/www.386387.xyz-access.log combined        SSLEngine on        SSLCertificateFile  /etc/apache2/certs/www.386387.xyz.crt        SSLCertificateKeyFile  /etc/apache2/certs/www.386387.xyz.key    </VirtualHost></IfModule>"><div></div></button></div></figure></div>
<p><strong>Enable the SSL site and reload Apache:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo a2ensite 000-virtual-ssl.conf</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo systemctl reload apache2</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo a2ensite 000-virtual-ssl.confsudo systemctl reload apache2"><div></div></button></div></figure></div>
<p>The web servers are now ready for HTTPS connections. The next step is to configure HAProxy to use HTTPS for backend connections.</p>
<div class="sl-heading-wrapper level-h3"><h3 id="810-configure-haproxy-for-backend-https-tls-re-encryption-run-on-www386387xyz">8.10. Configure HAProxy for Backend HTTPS (TLS Re-Encryption) (Run on <code dir="auto">www.386387.xyz</code>)</h3><a class="sl-anchor-link" href="#810-configure-haproxy-for-backend-https-tls-re-encryption-run-on-www386387xyz"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “8.10. Configure HAProxy for Backend HTTPS (TLS Re-Encryption) (Run on www.386387.xyz)”</span></a></div>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo nano /etc/haproxy/haproxy.cfg</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo nano /etc/haproxy/haproxy.cfg"><div></div></button></div></figure></div>
<p>Locate the <code dir="auto">backend be_http</code> section and modify the <code dir="auto">server</code> lines to use port 443 and the <code dir="auto">ssl</code> and <code dir="auto">verify none</code> parameters (since we are using self-signed certificates):</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">backend be_http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">balance  roundrobin</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv1 64.225.29.174:443 check ssl verify none</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server   srv2 165.227.176.14:443 check ssl verify none</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="backend be_http        balance  roundrobin        server   srv1 64.225.29.174:443 check ssl verify none        server   srv2 165.227.176.14:443 check ssl verify none"><div></div></button></div></figure></div>
<p><strong>Restart HAProxy:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo systemctl restart haproxy</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo systemctl restart haproxy"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="811-auto-http-to-https-redirection-run-on-www386387xyz">8.11. Auto HTTP to HTTPS Redirection (Run on <a href="http://www.386387.xyz">www.386387.xyz</a>)</h3><a class="sl-anchor-link" href="#811-auto-http-to-https-redirection-run-on-www386387xyz"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “8.11. Auto HTTP to HTTPS Redirection (Run on www.386387.xyz)”</span></a></div>
<p>To ensure all traffic uses encryption, we can force HTTP requests to redirect to HTTPS.</p>
<p>Edit the HAProxy configuration:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo nano /etc/haproxy/haproxy.cfg</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo nano /etc/haproxy/haproxy.cfg"><div></div></button></div></figure></div>
<p>In the <code dir="auto">frontend fe_http</code> section, add the following <code dir="auto">redirect</code> rule after the <code dir="auto">bind</code> lines:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">redirect scheme https if !{ ssl_fc }</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="        redirect scheme https if !{ ssl_fc }"><div></div></button></div></figure></div>
<p>The updated frontend section should look like this:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">frontend fe_http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">bind 159.203.70.143:80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">bind 159.203.70.143:443 ssl crt /etc/letsencrypt/live/www.386387.xyz/haproxy.pem</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">redirect scheme https if !{ ssl_fc }</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">acl acl_acme path_beg -i /.well-known/acme-challenge</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">use_backend be_acme if acl_acme</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">default_backend    be_http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">option   forwardfor</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="frontend fe_http        bind 159.203.70.143:80        bind 159.203.70.143:443 ssl crt /etc/letsencrypt/live/www.386387.xyz/haproxy.pem        redirect scheme https if !{ ssl_fc }        acl acl_acme path_beg -i /.well-known/acme-challenge        use_backend be_acme if acl_acme        default_backend    be_http        option   forwardfor"><div></div></button></div></figure></div>
<p><strong>Restart HAProxy:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo systemctl restart haproxy</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo systemctl restart haproxy"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="812-server-persistence-sticky-sessions-with-cookies">8.12. Server Persistence (Sticky Sessions) with Cookies</h3><a class="sl-anchor-link" href="#812-server-persistence-sticky-sessions-with-cookies"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “8.12. Server Persistence (Sticky Sessions) with Cookies”</span></a></div>
<p>For applications that require session persistence (e.g., when users are logged in), we need to ensure a client is directed to the same backend server for the duration of their session. This can be achieved using cookies.</p>
<p>Edit the HAProxy configuration:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo nano /etc/haproxy/haproxy.cfg</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo nano /etc/haproxy/haproxy.cfg"><div></div></button></div></figure></div>
<p>Modify the <code dir="auto">backend be_http</code> section to include cookie-based persistence:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">backend be_acme</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server self 127.0.0.1:80 check</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">backend be_http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">balance roundrobin</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">cookie ACTIVESERVER insert indirect nocache</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server srv1 64.225.29.174:443 check cookie srv1 ssl verify none</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server srv2 165.227.176.14:443 check cookie srv2 ssl verify none</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="backend be_acme        server self 127.0.0.1:80 checkbackend be_http        balance roundrobin        cookie ACTIVESERVER insert indirect nocache        server srv1 64.225.29.174:443 check cookie srv1 ssl verify none        server srv2 165.227.176.14:443 check cookie srv2 ssl verify none"><div></div></button></div></figure></div>
<p><strong>Restart HAProxy:</strong></p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">sudo systemctl restart haproxy</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo systemctl restart haproxy"><div></div></button></div></figure></div>
<div class="sl-heading-wrapper level-h3"><h3 id="813-final-contents-of-haproxy-config-file">8.13. Final Contents of HAProxy Config File</h3><a class="sl-anchor-link" href="#813-final-contents-of-haproxy-config-file"><span aria-hidden="true" class="sl-anchor-icon"><svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg></span><span class="sr-only">Section titled “8.13. Final Contents of HAProxy Config File”</span></a></div>
<p>The final <code dir="auto">/etc/haproxy/haproxy.cfg</code> file should look similar to this:</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre data-language="plaintext"><code><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">global</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">log /dev/log    local0</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">log /dev/log    local1 notice</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">chroot /var/lib/haproxy</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd lis></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">stats timeout 30s</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">user haproxy</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">group haproxy</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">daemon</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53"># Default SSL material locations</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">ca-base /etc/ssl/certs</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">crt-base /etc/ssl/private</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53"># See: https://ssl-config.mozilla.org/#server=haproxy&#x26;server-version=2.></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SH></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">defaults</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">log     global</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">mode    http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">option  httplog</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">option  dontlognull</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">timeout connect 5000</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">timeout client  50000</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">timeout server  50000</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">errorfile 400 /etc/haproxy/errors/400.http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">errorfile 403 /etc/haproxy/errors/403.http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">errorfile 408 /etc/haproxy/errors/408.http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">errorfile 500 /etc/haproxy/errors/500.http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">errorfile 502 /etc/haproxy/errors/502.http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">errorfile 503 /etc/haproxy/errors/503.http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">errorfile 504 /etc/haproxy/errors/504.http</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">frontend fe_http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">bind 159.203.70.143:80</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">bind 159.203.70.143:443 ssl crt /etc/letsencrypt/live/www.386387.xyz/haproxy.pem</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">redirect scheme https if !{ ssl_fc }</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">acl acl_acme path_beg -i /.well-known/acme-challenge</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">use_backend be_acme if acl_acme</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">default_backend    be_http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">option   forwardfor</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">backend be_acme</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server self 127.0.0.1:80 check</span></div></div><div class="ec-line"><div class="code"><span style="--0:#d6deeb;--1:#403f53">backend be_http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">balance  roundrobin</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">cookie ACTIVESERVER insert indirect nocache</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server srv1 64.225.29.174:443 check cookie srv1 ssl verify none</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#d6deeb;--1:#403f53">        </span></span><span style="--0:#d6deeb;--1:#403f53">server srv2 165.227.176.14:443 check cookie srv2 ssl verify none</span></div></div></code></pre><div class="copy"><div aria-live="polite"></div><button title="Copy to clipboard" data-copied="Copied!" data-code="global        log /dev/log    local0        log /dev/log    local1 notice        chroot /var/lib/haproxy        stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd lis>        stats timeout 30s        user haproxy        group haproxy        daemon        # Default SSL material locations        ca-base /etc/ssl/certs        crt-base /etc/ssl/private        # See: https://ssl-config.mozilla.org/#server=haproxy&#x26;server-version=2.>        ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128>        ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SH>        ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-ticketsdefaults        log     global        mode    http        option  httplog        option  dontlognull        timeout connect 5000        timeout client  50000        timeout server  50000        errorfile 400 /etc/haproxy/errors/400.http        errorfile 403 /etc/haproxy/errors/403.http        errorfile 408 /etc/haproxy/errors/408.http        errorfile 500 /etc/haproxy/errors/500.http        errorfile 502 /etc/haproxy/errors/502.http        errorfile 503 /etc/haproxy/errors/503.http        errorfile 504 /etc/haproxy/errors/504.httpfrontend fe_http        bind 159.203.70.143:80        bind 159.203.70.143:443 ssl crt /etc/letsencrypt/live/www.386387.xyz/haproxy.pem        redirect scheme https if !{ ssl_fc }        acl acl_acme path_beg -i /.well-known/acme-challenge        use_backend be_acme if acl_acme        default_backend    be_http        option   forwardforbackend be_acme        server self 127.0.0.1:80 checkbackend be_http        balance  roundrobin        cookie ACTIVESERVER insert indirect nocache        server srv1 64.225.29.174:443 check cookie srv1 ssl verify none        server srv2 165.227.176.14:443 check cookie srv2 ssl verify none"><div></div></button></div></figure></div> </div> <footer class="sl-flex astro-3yyafb3n"> <div class="meta sl-flex astro-3yyafb3n">   </div> <div class="pagination-links print:hidden astro-u2l5gyhi" dir="ltr">   </div>   </footer>  </div> </div>   </main> </div> </div>  </div> </div>  </body></html>